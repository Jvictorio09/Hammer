{% extends "dashboard/base.html" %}
{% load form_extras %}

<style>
.gallery-preview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.gallery-item {
  position: relative;
  cursor: pointer;
  border-radius: 0.5rem;
  overflow: hidden;
  transition: all 0.3s ease;
  opacity: 0.7;
}

.gallery-item.active {
  opacity: 1;
  transform: scale(1.05);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.gallery-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.gallery-item:hover img {
  transform: scale(1.05);
}

.gallery-item .cap {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
  color: white;
  padding: 1rem 0.5rem 0.5rem;
  font-size: 0.875rem;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.gallery-item:hover .cap,
.gallery-item.active .cap {
  opacity: 1;
}

@media (max-width: 768px) {
  .gallery-preview {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.5rem;
  }
  
  .gallery-item img {
    height: 120px;
  }
}
</style>

{% block page_title %}{% if mode == 'edit' %}Edit Service{% else %}New Service{% endif %}{% endblock %}

{% block content %}
<!-- Display Django messages -->
{% if messages %}
<div class="mb-4 space-y-2">
  {% for message in messages %}
  <div class="rounded-lg p-4 {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
    <div class="flex items-start">
      <div class="flex-1">
        <p class="text-sm font-medium">{{ message }}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<form method="post" class="min-h-screen">
  {% csrf_token %}

  <!-- Header -->
  <div class="mb-4 flex items-center justify-between">
    <h1 class="text-xl font-semibold text-gray-900">{% if mode == 'edit' %}Edit{% else %}New{% endif %} Service</h1>
    <div class="hidden md:flex gap-2">
      <a href="{% url 'dashboard_services_list' %}" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</a>
      <button type="submit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black">Save</button>
    </div>
  </div>

  <!-- Tab bar -->
  <div id="tablist" role="tablist" class="sticky top-0 z-10 -mx-4 px-4 bg-white/90 backdrop-blur border-b">
    <div class="mx-auto max-w-6xl">
      <div class="flex gap-1 overflow-x-auto py-2">
        {% for t in "Basics,Hero,Content,Stats & SEO,Images,Projects,Capabilities,Insights,Settings"|split_string %}
          {% with slug=t|slugify %}
          <button type="button" role="tab" data-tab="{{ slug }}"
            class="tab-btn px-3 py-2 text-sm rounded-lg border border-transparent text-gray-600 hover:text-gray-900"
            aria-controls="tab-{{ slug }}" aria-selected="false">{{ t }}</button>
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-6xl space-y-6 py-4">

    <!-- BASICS -->
    <section id="tab-basics" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Basics</h2>
      <div class="grid md:grid-cols-2 gap-4">
        {% include "dashboard/_field.html" with field=form.title required=1 placeholder="e.g., AI Consulting" %}
        {% include "dashboard/_field.html" with field=form.slug help="Auto-filled from title. You can tweak." %}
      </div>
      {% include "dashboard/_field.html" with field=form.eyebrow placeholder="Small label above the headline" %}
    </section>

    <!-- HERO (with preview) -->
    <section id="tab-hero" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Hero</h2>
      {% include "dashboard/_field.html" with field=form.hero_headline required=1 placeholder="Headline‚Ä¶" %}
      {% include "dashboard/_field.html" with field=form.hero_subcopy input_type="textarea" rows="3" placeholder="Short subcopy‚Ä¶" %}

      <div class="grid md:grid-cols-[1fr,280px] gap-4">
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="flex-1">
              {% include "dashboard/_field.html" with field=form.hero_media_url placeholder="https://‚Ä¶" %}
            </div>
            <button type="button" class="gallery-btn-hero px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
              üì∑ Gallery
            </button>
          </div>
          {% include "dashboard/_field.html" with field=form.canonical_path placeholder="/services/ai-consulting" %}
          <p class="text-xs text-gray-500">Best image size: 1600√ó900 (16:9).</p>
        </div>
        <aside>
          <div class="text-xs font-medium text-gray-700 mb-2">Hero preview</div>
          <div class="relative aspect-video overflow-hidden rounded-xl border border-gray-200 bg-gray-50">
            <img id="heroPreview" class="h-full w-full object-cover opacity-0 transition-opacity" alt="Hero preview" />
            <div id="heroEmpty" class="absolute inset-0 grid place-items-center text-gray-400 text-xs">Paste an image URL</div>
          </div>
          <div id="heroPreviewMeta" class="mt-2 text-[11px] text-gray-500 truncate"></div>
        </aside>
      </div>
    </section>

    <!-- CONTENT (Pinned + Insights) -->
    <section id="tab-content" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Pinned & Insights</h2>

      <div class="space-y-4">
        <h3 class="text-xs uppercase tracking-wide text-gray-500">Pinned Content</h3>
        {% include "dashboard/_field.html" with field=form.pinned_heading placeholder="What we do" %}
        {% include "dashboard/_field.html" with field=form.pinned_title required=1 placeholder="End-to-end landscape design & build" %}
        <div class="grid md:grid-cols-2 gap-4">
          {% include "dashboard/_field.html" with field=form.pinned_body_1 input_type="textarea" rows="3" placeholder="First paragraph..." %}
          {% include "dashboard/_field.html" with field=form.pinned_body_2 input_type="textarea" rows="3" placeholder="Second paragraph..." %}
        </div>
      </div>

      <div class="mt-6 space-y-4">
        <h3 class="text-xs uppercase tracking-wide text-gray-500">Insights Rail</h3>
        {% include "dashboard/_field.html" with field=form.insights_heading placeholder="Latest Insights" %}
        {% include "dashboard/_field.html" with field=form.insights_subcopy input_type="textarea" rows="2" placeholder="Short description..." %}
      </div>
    </section>

    <!-- STATS & SEO -->
    <section id="tab-stats-seo" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Stats & SEO</h2>
      <div class="grid md:grid-cols-3 gap-4">
        {% include "dashboard/_field.html" with field=form.stat_projects placeholder="650+" %}
        {% include "dashboard/_field.html" with field=form.stat_years placeholder="20+" %}
        {% include "dashboard/_field.html" with field=form.stat_specialists placeholder="1000+" %}
      </div>
      <div class="grid md:grid-cols-2 gap-4 mt-6">
        {% include "dashboard/_field.html" with field=form.seo_meta_title placeholder="Service Title ‚Äì Company" %}
        {% include "dashboard/_field.html" with field=form.seo_meta_description input_type="textarea" rows="2" placeholder="Meta description‚Ä¶" %}
      </div>
    </section>

    <!-- IMAGES (before/after) -->
    <section id="tab-images" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-900">Before/After Images</h2>
        <button type="button" id="add-image" class="text-sm font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">+ Add Image</button>
      </div>

      <div id="images-container" class="space-y-4">
        {{ image_formset.management_form }}
        {% for form in image_formset %}
        <div class="image-form border border-gray-200 rounded-lg p-4 {% if not form.instance.pk %}new-form{% endif %}">
          {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
          <div class="grid md:grid-cols-[1fr,220px] gap-4">
            <div class="space-y-3">
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Image URL</label>
                  <div class="flex items-center gap-2">
                    {{ form.image_url }}
                    <button type="button" class="gallery-btn-image px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                      üì∑
                    </button>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Caption</label>
                  {{ form.caption }}
                </div>
              </div>
              <div class="flex items-center gap-3">
                <label class="text-xs text-gray-600">Order:</label>
                {{ form.sort_order }}
              </div>
            </div>
            <div class="md:justify-self-end">
              <div class="text-[11px] font-medium text-gray-700 mb-2">Preview</div>
              <div class="relative aspect-video w-[220px] overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
                <img class="imagePreview h-full w-full object-cover opacity-0 transition-opacity" alt="Image preview" />
                <div class="imageEmpty absolute inset-0 grid place-items-center text-gray-400 text-[11px]">No image</div>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between mt-3">
            <div class="text-[11px] text-gray-500">ID: {{ form.id }}</div>
            {% if form.instance.pk %}
              <button type="button" class="remove-image text-red-600 hover:text-red-800 text-sm">Remove</button>
            {% endif %}
          </div>
          {{ form.id }}
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- PROJECTS (consolidated case studies) -->
    <section id="tab-projects" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-sm font-semibold text-gray-900">Projects Portfolio</h2>
          <p class="text-xs text-gray-600 mt-1">Each project includes details + images shown on service page gallery</p>
        </div>
        <button type="button" id="add-case-study" class="text-sm font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">+ Add Project</button>
      </div>

        <div id="case-studies-container" class="space-y-4">
          {{ case_study_formset.management_form }}
          {% for form in case_study_formset %}
          <div class="case-study-form border border-gray-200 rounded-lg p-4 {% if not form.instance.pk %}new-form{% endif %}">
            {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
            <div class="grid md:grid-cols-[1fr,300px] gap-4">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Project Title</label>
                  {{ form.title }}
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Hero (Detail Page)</label>
                    <div class="flex items-center gap-2">
                      {{ form.hero_image_url }}
                      <button type="button" class="gallery-btn-case-study px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                        üì∑
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Thumbnail (Gallery)</label>
                    <div class="flex items-center gap-2">
                      {{ form.thumb_url }}
                      <button type="button" class="gallery-btn-thumb px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                        üì∑
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Full Size (Gallery)</label>
                    <div class="flex items-center gap-2">
                      {{ form.full_url }}
                      <button type="button" class="gallery-btn-full px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                        üì∑
                      </button>
                    </div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Summary (Brief)</label>
                  {{ form.summary }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Description (Full Story)</label>
                  {{ form.description }}
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Completion Date</label>
                    {{ form.completion_date }}
                  </div>
                  <div></div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Scope</label>
                    {{ form.scope }}
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Size</label>
                    {{ form.size_label }}
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Timeline</label>
                    {{ form.timeline_label }}
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                    {{ form.status_label }}
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Tags (comma-separated)</label>
                  {{ form.tags_csv }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">CTA URL (optional)</label>
                  {{ form.cta_url }}
                </div>
                
                <!-- Gallery Images Section -->
                <div class="border-t border-gray-200 pt-4">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <h4 class="text-xs font-medium text-gray-700">Gallery Images</h4>
                      <p class="text-xs text-gray-500 mt-1">Upload images and they'll be pre-selected. Click Edit to manage.</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <button type="button" class="gallery-edit-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">
                        ‚úèÔ∏è Edit Gallery
                      </button>
                      <button type="button" class="gallery-upload-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">
                        üì∑ Upload Gallery
                      </button>
                    </div>
                  </div>
                  <div class="gallery-preview grid grid-cols-3 gap-2 min-h-[60px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="text-xs text-gray-500 text-center py-4 col-span-3">No gallery images</div>
                  </div>
                  <!-- Hidden input to store selected gallery images -->
                  {{ form.gallery_urls }}
                </div>
                
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Featured:</label>
                    {{ form.is_featured }}
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600">Order:</label>
                    {{ form.sort_order }}
                  </div>
                </div>
              </div>
              <div class="md:justify-self-end">
                <div class="text-[11px] font-medium text-gray-700 mb-2">Preview</div>
                <div class="relative aspect-video w-[300px] overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
                  <img class="caseStudyPreview h-full w-full object-cover opacity-0 transition-opacity" alt="Case study preview" />
                  <div class="caseStudyEmpty absolute inset-0 grid place-items-center text-gray-400 text-[11px]">No image</div>
                </div>
                <div class="mt-2 text-[11px] text-gray-500">
                  {% if form.instance.pk %}
                    <div>ID: {{ form.instance.id }}</div>
                    <div>Slug: {{ form.instance.slug }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="flex items-center justify-between mt-3">
              <div class="text-[11px] text-gray-500">ID: {{ form.id }}</div>
              {% if form.instance.pk %}
                <button type="button" class="remove-case-study text-red-600 hover:text-red-800 text-sm">Remove</button>
              {% endif %}
            </div>
            {{ form.id }}
          </div>
          {% endfor %}
        </div>
    </section>

    <!-- CAPABILITIES -->
    <section id="tab-capabilities" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-900">Service Capabilities</h2>
        <button type="button" id="add-capability" class="text-sm font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">+ Add Capability</button>
      </div>

      <div id="capabilities-container" class="space-y-4">
        {{ capability_formset.management_form }}
        {% for form in capability_formset %}
        <div class="capability-form border border-gray-200 rounded-lg p-4 {% if not form.instance.pk %}new-form{% endif %}">
          {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
              {{ form.title }}
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Icon Class</label>
              {{ form.icon_class }}
              <button type="button" class="mt-2 px-3 py-1.5 text-xs bg-teal-50 text-teal-700 rounded-lg hover:bg-teal-100 transition-colors" onclick="openIconPicker(this.closest('div').querySelector('input'))">
                <i class="fa-solid fa-icons mr-1"></i> Choose Icon
              </button>
              <div class="mt-2 text-xs text-gray-500">
                Current: <i class="{{ form.icon_class.value|default:'fa-solid fa-circle' }} text-teal-600"></i>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
            {{ form.blurb }}
          </div>
          <div class="flex items-center gap-2 mt-3">
            <label class="text-xs text-gray-600">Order:</label>
            {{ form.sort_order }}
          </div>
          {{ form.id }}
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- INSIGHTS -->
    <section id="tab-insights" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-900">Connected Insights</h2>
        <div class="flex gap-2">
          <a href="{% url 'dashboard_insights_list' %}" class="text-sm font-medium px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">View All Insights</a>
          <a href="{% url 'dashboard_insight_create' %}?service={{ service.id }}" class="text-sm font-medium px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:bg-black">+ New Insight</a>
        </div>
      </div>

      {% if service.insights.all %}
        <div class="space-y-4">
          {% for insight in service.insights.all %}
          <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="font-medium text-gray-900">{{ insight.title }}</h3>
                  {% if insight.published %}
                    <span class="px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-full">Published</span>
                  {% else %}
                    <span class="px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 rounded-full">Draft</span>
                  {% endif %}
                  {% if insight.tag %}
                    <span class="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded-full">{{ insight.tag }}</span>
                  {% endif %}
                </div>
                {% if insight.excerpt %}
                  <p class="text-sm text-gray-600 mb-2">{{ insight.excerpt }}</p>
                {% endif %}
                <div class="flex items-center gap-4 text-xs text-gray-500">
                  <span>{{ insight.read_minutes }} min read</span>
                  {% if insight.published_at %}
                    <span>Published {{ insight.published_at|date:"M j, Y" }}</span>
                  {% endif %}
                  <span>Created {{ insight.created_at|date:"M j, Y" }}</span>
                </div>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <a href="{% url 'dashboard_insight_edit' insight.id %}" class="text-sm text-blue-600 hover:text-blue-800">Edit</a>
                <a href="{% url 'insight_detail' insight.slug %}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800">View</a>
              </div>
            </div>
            {% if insight.cover_image_url %}
              <div class="mt-3">
                <img src="{{ insight.cover_image_url }}" alt="{{ insight.title }}" class="w-32 h-20 object-cover rounded-lg">
              </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8">
          <div class="text-gray-400 mb-4">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <h3 class="text-sm font-medium text-gray-900 mb-1">No insights yet</h3>
          <p class="text-sm text-gray-500 mb-4">Create your first insight to showcase your expertise in this service area.</p>
          <a href="{% url 'dashboard_insight_create' %}?service={{ service.id }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg hover:bg-black">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create First Insight
          </a>
        </div>
      {% endif %}
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" role="tabpanel" class="tab-panel rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Settings</h2>
      <div class="grid md:grid-cols-2 gap-4">
        {% include "dashboard/_field.html" with field=form.is_active %}
        {% include "dashboard/_field.html" with field=form.sort_order input_mode="numeric" placeholder="e.g., 10" %}
      </div>
    </section>

  </div>

  <!-- Sticky actions -->
  <div class="sticky bottom-0 mt-4 border-t bg-white/85 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div id="dirtyFlag" class="text-sm text-gray-500">All changes saved</div>
      <div class="flex gap-2">
        <a href="{% url 'dashboard_services_list' %}" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</a>
        <button type="submit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black">Save</button>
      </div>
    </div>
  </div>
</form>

<script>
// Image compression utility
async function compressImage(file, maxSizeMB = 8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Calculate new dimensions while maintaining aspect ratio
        const maxDimension = 4096; // Max dimension for large images
        if (width > maxDimension || height > maxDimension) {
          if (width > height) {
            height = (height / width) * maxDimension;
            width = maxDimension;
          } else {
            width = (width / height) * maxDimension;
            height = maxDimension;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Try different quality levels to get under the target size
        let quality = 0.9;
        const tryCompress = () => {
          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error('Compression failed'));
                return;
              }
              
              const sizeMB = blob.size / 1024 / 1024;
              console.log(`Compressed to ${sizeMB.toFixed(2)}MB at quality ${quality}`);
              
              // If still too large and quality can be reduced further, try again
              if (sizeMB > maxSizeMB && quality > 0.5) {
                quality -= 0.1;
                tryCompress();
              } else {
                // Create a File object from the blob
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              }
            },
            'image/jpeg',
            quality
          );
        };
        
        tryCompress();
      };
      img.onerror = () => reject(new Error('Failed to load image'));
      img.src = e.target.result;
    };
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsDataURL(file);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // ----------------- Tabs -----------------
  const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
  const panels  = Array.from(document.querySelectorAll('.tab-panel'));
  function activate(tab){ // tab = slug
    tabBtns.forEach(b=>{
      const on = b.dataset.tab === tab;
      b.setAttribute('aria-selected', on);
      b.classList.toggle('bg-gray-100', on);
      b.classList.toggle('border-gray-300', on);
    });
    panels.forEach(p=>{
      p.classList.toggle('hidden', p.id !== 'tab-'+tab);
    });
    history.replaceState(null, '', '#'+tab);
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
  const initial = (location.hash || '#basics').replace('#','');
  activate(initial);
  tabBtns.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));

  // ----------------- Field chrome (for formset inputs) -----------------
  function addChrome(sel){
    document.querySelectorAll(sel).forEach(el=>{
      el.classList.add('w-full','rounded-xl','border','border-gray-300','px-3','py-2',
                       'focus:outline-none','focus:ring-2','focus:ring-gray-900/10','focus:border-gray-400','transition');
    });
  }
  addChrome('.capability-form input, .capability-form textarea, .image-form input');

  // ----------------- Hero preview -----------------
  const heroInput = document.querySelector('input[name="hero_media_url"]');
  const heroImg   = document.getElementById('heroPreview');
  const heroEmpty = document.getElementById('heroEmpty');
  const heroMeta  = document.getElementById('heroPreviewMeta');
  
  console.log('Hero preview elements:', { heroInput, heroImg, heroEmpty, heroMeta });
  
  function looksLikeImage(url){ 
    if (!url || !url.trim()) return false;
    const cleanUrl = url.trim();
    // Check if it's a valid URL and looks like an image
    return /^https?:\/\//i.test(cleanUrl) && (
      /\.(png|jpe?g|webp|gif|avif|svg)(\?.*)?$/i.test(cleanUrl) || 
      /cloudinary\.com.*\.(png|jpe?g|webp|gif|avif|svg)/i.test(cleanUrl) ||
      /\.(png|jpe?g|webp|gif|avif|svg)$/i.test(cleanUrl.split('?')[0])
    );
  }
  function updateHero(){
    const v = (heroInput?.value||'').trim();
    console.log('Hero input value:', v);
    if (v && /^https?:\/\//i.test(v)) {
      // Try to load the image regardless of extension
      heroImg.src = v;
      heroImg.onload = ()=>{ 
        console.log('Hero image loaded successfully');
        heroImg.classList.remove('opacity-0'); 
        heroEmpty.style.display='none'; 
      };
      heroImg.onerror = ()=>{ 
        console.log('Hero image failed to load');
        heroImg.classList.add('opacity-0'); 
        heroEmpty.style.display='grid'; 
      };
      if (heroMeta) heroMeta.textContent = v;
    } else {
      heroImg.removeAttribute('src'); 
      heroImg.classList.add('opacity-0'); 
      heroEmpty.style.display='grid';
      if (heroMeta) heroMeta.textContent = '';
    }
  }
  if (heroInput && heroImg) { 
    console.log('Setting up hero preview');
    updateHero(); 
    heroInput.addEventListener('input', updateHero); 
  } else {
    console.log('Hero preview setup failed - missing elements');
  }

  // ----------------- Image row previews -----------------
  function wireRow(row){
    const url = row.querySelector('input[name$="-image_url"]');
    const img = row.querySelector('.imagePreview');
    const empty = row.querySelector('.imageEmpty');
    console.log('Wiring image row:', { url, img, empty });
    if (!url || !img || !empty) {
      console.log('Missing elements in image row');
      return;
    }
    function upd(){
      const v = (url.value||'').trim();
      console.log('Image input value:', v);
      if (v && /^https?:\/\//i.test(v)) {
        // Try to load the image regardless of extension
        img.src = v;
        img.onload = ()=>{ 
          console.log('Image loaded successfully');
          img.classList.remove('opacity-0'); 
          empty.style.display='none'; 
        };
        img.onerror = ()=>{ 
          console.log('Image failed to load');
          img.classList.add('opacity-0'); 
          empty.style.display='grid'; 
        };
      } else {
        img.removeAttribute('src'); 
        img.classList.add('opacity-0'); 
        empty.style.display='grid';
      }
    }
    upd(); url.addEventListener('input', upd);
  }
  console.log('Setting up image previews for', document.querySelectorAll('.image-form').length, 'forms');
  document.querySelectorAll('.image-form').forEach(wireRow);

  // ----------------- Case Study/Project row previews -----------------
  function wireCaseStudyRow(row){
    const heroUrl = row.querySelector('input[name$="-hero_image_url"]');
    const img = row.querySelector('.caseStudyPreview');
    const empty = row.querySelector('.caseStudyEmpty');
    console.log('Wiring case study row:', { heroUrl, img, empty });
    if (!heroUrl || !img || !empty) {
      console.log('Missing elements in case study row');
      return;
    }
    function upd(){
      const v = (heroUrl.value||'').trim();
      console.log('Case study image input value:', v);
      if (v && /^https?:\/\//i.test(v)) {
        // Try to load the image regardless of extension
        img.src = v;
        img.onload = ()=>{ 
          console.log('Case study image loaded successfully');
          img.classList.remove('opacity-0'); 
          empty.style.display='none'; 
        };
        img.onerror = ()=>{ 
          console.log('Case study image failed to load');
          img.classList.add('opacity-0'); 
          empty.style.display='grid'; 
        };
      } else {
        img.removeAttribute('src'); 
        img.classList.add('opacity-0'); 
        empty.style.display='grid';
      }
    }
    upd(); 
    heroUrl.addEventListener('input', upd);
  }
  console.log('Setting up case study previews for', document.querySelectorAll('.case-study-form').length, 'forms');
  document.querySelectorAll('.case-study-form').forEach(wireCaseStudyRow);

  // ----------------- Add/Remove capability rows -----------------
  const capBox = document.getElementById('capabilities-container');
  const addCap = document.getElementById('add-capability');
  let capCount = capBox ? capBox.querySelectorAll('.capability-form').length : 0;
  addCap?.addEventListener('click', ()=>{
    const n = document.createElement('div');
    n.className = 'capability-form border border-gray-200 rounded-lg p-4 new-form';
    n.innerHTML = `
      <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
          <input type="text" name="capabilities-${capCount}-title" class="w-full rounded-xl border border-gray-300 px-3 py-2"></div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Icon Class</label>
          <input type="text" name="capabilities-${capCount}-icon_class" class="w-full rounded-xl border border-gray-300 px-3 py-2">
          <button type="button" class="mt-2 px-3 py-1.5 text-xs bg-teal-50 text-teal-700 rounded-lg hover:bg-teal-100 transition-colors" onclick="openIconPicker(this.previousElementSibling)">
            <i class="fa-solid fa-icons mr-1"></i> Choose Icon
          </button>
        </div>
      </div>
      <div class="mt-3"><label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
        <input type="text" name="capabilities-${capCount}-blurb" class="w-full rounded-xl border border-gray-300 px-3 py-2"></div>
      <div class="flex items-center gap-2 mt-3"><label class="text-xs text-gray-600">Order:</label>
        <input type="number" name="capabilities-${capCount}-sort_order" class="w-24 rounded-xl border border-gray-300 px-3 py-2" value="${capCount}" min="0"></div>
      <input type="hidden" name="capabilities-${capCount}-id" value="">
    `;
    capBox.appendChild(n); capCount++;
    const total = document.querySelector('input[name="capabilities-TOTAL_FORMS"]'); if (total) total.value = capCount;
    addChrome('.capability-form input, .capability-form textarea');
  });

  // ----------------- Add/Remove image rows -----------------
  const imgBox = document.getElementById('images-container');
  const addImg = document.getElementById('add-image');
  let imgCount = imgBox ? imgBox.querySelectorAll('.image-form').length : 0;
  addImg?.addEventListener('click', ()=>{
    const n = document.createElement('div');
    n.className = 'image-form border border-gray-200 rounded-lg p-4 new-form';
    n.innerHTML = `
      <div class="grid md:grid-cols-[1fr,220px] gap-4">
        <div class="space-y-3">
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Image URL</label>
              <div class="flex items-center gap-2">
                <input type="url" name="images-${imgCount}-image_url" class="flex-1 rounded-xl border border-gray-300 px-3 py-2" placeholder="https://‚Ä¶">
                <button type="button" class="gallery-btn-image px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                  üì∑
                </button>
              </div>
            </div>
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Caption</label>
              <input type="text" name="images-${imgCount}-caption" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="Image caption‚Ä¶"></div>
          </div>
          <div class="flex items-center gap-2"><label class="text-xs text-gray-600">Order:</label>
            <input type="number" name="images-${imgCount}-sort_order" class="w-24 rounded-xl border border-gray-300 px-3 py-2" value="${imgCount}" min="0"></div>
        </div>
        <div class="md:justify-self-end">
          <div class="text-[11px] font-medium text-gray-700 mb-2">Preview</div>
          <div class="relative aspect-video w-[220px] overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
            <img class="imagePreview h-full w-full object-cover opacity-0 transition-opacity" alt="Image preview" />
            <div class="imageEmpty absolute inset-0 grid place-items-center text-gray-400 text-[11px]">No image</div>
          </div>
        </div>
      </div>
      <div class="mt-3 text-[11px] text-gray-500">ID: <input type="hidden" name="images-${imgCount}-id" value=""></div>
    `;
    imgBox.appendChild(n); imgCount++;
    const total = document.querySelector('input[name="images-TOTAL_FORMS"]'); if (total) total.value = imgCount;
    addChrome('.image-form input'); wireRow(n);
  });

  // ----------------- Add/Remove case study/project rows -----------------
  const caseStudyBox = document.getElementById('case-studies-container');
  const addCaseStudy = document.getElementById('add-case-study');
  let caseStudyCount = caseStudyBox ? caseStudyBox.querySelectorAll('.case-study-form').length : 0;
  addCaseStudy?.addEventListener('click', ()=>{
    const n = document.createElement('div');
    n.className = 'case-study-form border border-gray-200 rounded-lg p-4 new-form';
    n.innerHTML = `
      <div class="grid md:grid-cols-[1fr,300px] gap-4">
        <div class="space-y-3">
          <div><label class="block text-xs font-medium text-gray-700 mb-1">Project Title</label>
            <input type="text" name="case_studies-${caseStudyCount}-title" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="Project title..."></div>
          <div class="grid md:grid-cols-3 gap-4">
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Hero (Detail Page)</label>
              <div class="flex items-center gap-2">
                <input type="url" name="case_studies-${caseStudyCount}-hero_image_url" class="flex-1 rounded-xl border border-gray-300 px-3 py-2" placeholder="https://...">
                <button type="button" class="gallery-btn-case-study px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                  üì∑
                </button>
              </div>
            </div>
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Thumbnail (Gallery)</label>
              <div class="flex items-center gap-2">
                <input type="url" name="case_studies-${caseStudyCount}-thumb_url" class="flex-1 rounded-xl border border-gray-300 px-3 py-2" placeholder="https://...">
                <button type="button" class="gallery-btn-thumb px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                  üì∑
                </button>
              </div>
            </div>
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Full Size (Gallery)</label>
              <div class="flex items-center gap-2">
                <input type="url" name="case_studies-${caseStudyCount}-full_url" class="flex-1 rounded-xl border border-gray-300 px-3 py-2" placeholder="https://...">
                <button type="button" class="gallery-btn-full px-2 py-2 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                  üì∑
                </button>
              </div>
            </div>
          </div>
          <div><label class="block text-xs font-medium text-gray-700 mb-1">Summary (Brief)</label>
            <textarea name="case_studies-${caseStudyCount}-summary" class="w-full rounded-xl border border-gray-300 px-3 py-2" rows="3" placeholder="Brief summary (shown in cards and hero)..."></textarea></div>
          <div><label class="block text-xs font-medium text-gray-700 mb-1">Description (Full Story)</label>
            <textarea name="case_studies-${caseStudyCount}-description" class="w-full rounded-xl border border-gray-300 px-3 py-2" rows="4" placeholder="Full project description, challenges, solutions, and outcomes..."></textarea></div>
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Completion Date</label>
              <input type="date" name="case_studies-${caseStudyCount}-completion_date" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="YYYY-MM-DD"></div>
            <div></div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Scope</label>
              <input type="text" name="case_studies-${caseStudyCount}-scope" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="e.g., Design + Build"></div>
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Size</label>
              <input type="text" name="case_studies-${caseStudyCount}-size_label" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="e.g., 5,000 sq ft"></div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Timeline</label>
              <input type="text" name="case_studies-${caseStudyCount}-timeline_label" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="e.g., 6 months"></div>
            <div><label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
              <input type="text" name="case_studies-${caseStudyCount}-status_label" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="e.g., Completed"></div>
          </div>
          <div><label class="block text-xs font-medium text-gray-700 mb-1">Tags (comma-separated)</label>
            <input type="text" name="case_studies-${caseStudyCount}-tags_csv" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="e.g., Architecture, Interior Fit-Out, Joinery, Landscape"></div>
          <div><label class="block text-xs font-medium text-gray-700 mb-1">CTA URL (optional)</label>
            <input type="url" name="case_studies-${caseStudyCount}-cta_url" class="w-full rounded-xl border border-gray-300 px-3 py-2" placeholder="https://... (optional detail page)"></div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">Featured:</label>
              <input type="checkbox" name="case_studies-${caseStudyCount}-is_featured" class="rounded border-gray-300">
            </div>
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">Order:</label>
              <input type="number" name="case_studies-${caseStudyCount}-sort_order" class="w-24 rounded-xl border border-gray-300 px-3 py-2" value="${caseStudyCount}" min="0">
            </div>
          </div>
        </div>
        <div class="md:justify-self-end">
          <div class="text-[11px] font-medium text-gray-700 mb-2">Preview</div>
          <div class="relative aspect-video w-[300px] overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
            <img class="caseStudyPreview h-full w-full object-cover opacity-0 transition-opacity" alt="Case study preview" />
            <div class="caseStudyEmpty absolute inset-0 grid place-items-center text-gray-400 text-[11px]">No image</div>
          </div>
        </div>
      </div>
      <div class="mt-3 text-[11px] text-gray-500">ID: <input type="hidden" name="case_studies-${caseStudyCount}-id" value=""></div>
    `;
    caseStudyBox.appendChild(n); caseStudyCount++;
    const total = document.querySelector('input[name="case_studies-TOTAL_FORMS"]'); if (total) total.value = caseStudyCount;
    addChrome('.case-study-form input, .case-study-form textarea'); wireCaseStudyRow(n);
  });

  // ----------------- Gallery functionality -----------------
  let currentTargetInput = null;
  
  function openGallery(targetInput) {
    currentTargetInput = targetInput;
    // Create gallery modal if it doesn't exist
    let modal = document.getElementById('galleryModal');
    if (!modal) {
      modal = createGalleryModal();
      document.body.appendChild(modal);
    }
    modal.classList.remove('hidden');
    loadGalleryImages();
  }

  function createGalleryModal() {
    const modal = document.createElement('div');
    modal.id = 'galleryModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 hidden';
    modal.innerHTML = `
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Image Gallery</h3>
            <button id="closeGallery" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Tab Navigation -->
          <div class="flex border-b border-gray-200">
            <button id="galleryTab" class="flex-1 px-6 py-3 text-sm font-medium text-gray-900 border-b-2 border-gray-900 bg-gray-50">
              üì∑ Gallery
            </button>
            <button id="uploadTab" class="flex-1 px-6 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-50">
              ‚¨ÜÔ∏è Upload
            </button>
          </div>
          
          <!-- Tab Content -->
          <div class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- Gallery Tab -->
            <div id="galleryTabContent" class="tab-content">
              <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Images will be loaded here -->
              </div>
            </div>
            
            <!-- Upload Tab -->
            <div id="uploadTabContent" class="tab-content hidden">
              <div class="max-w-md mx-auto">
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition">
                  <input type="file" id="imageUpload" accept="image/*" class="hidden" multiple>
                  <label for="imageUpload" class="cursor-pointer">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                      <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="mt-4">
                      <p class="text-sm font-medium text-gray-900">Upload Images (Bulk)</p>
                      <p class="text-xs text-gray-500">Click to select multiple files or drag and drop</p>
                      <p class="text-xs text-gray-400 mt-1">Supports: JPG, PNG, WebP (max 10MB each)</p>
                    </div>
                  </label>
                </div>
                
                <div id="uploadProgress" class="mt-4 hidden">
                  <div class="bg-gray-200 rounded-full h-2">
                    <div id="uploadBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <p id="uploadStatus" class="text-sm text-gray-600 mt-2">Uploading...</p>
                </div>
                
                <div id="uploadedImages" class="mt-4 grid grid-cols-2 gap-2">
                  <!-- Newly uploaded images will appear here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Add event listeners
    modal.querySelector('#closeGallery').addEventListener('click', () => {
      modal.classList.add('hidden');
    });
    
    // Tab switching
    const galleryTab = modal.querySelector('#galleryTab');
    const uploadTab = modal.querySelector('#uploadTab');
    const galleryTabContent = modal.querySelector('#galleryTabContent');
    const uploadTabContent = modal.querySelector('#uploadTabContent');
    
    galleryTab.addEventListener('click', () => {
      galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.remove('text-gray-500', 'border-transparent');
      uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.add('text-gray-500', 'border-transparent');
      galleryTabContent.classList.remove('hidden');
      uploadTabContent.classList.add('hidden');
    });
    
    uploadTab.addEventListener('click', () => {
      uploadTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.remove('text-gray-500', 'border-transparent');
      galleryTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.add('text-gray-500', 'border-transparent');
      uploadTabContent.classList.remove('hidden');
      galleryTabContent.classList.add('hidden');
    });
    
    // File upload handling
    const fileInput = modal.querySelector('#imageUpload');
    const uploadProgress = modal.querySelector('#uploadProgress');
    const uploadBar = modal.querySelector('#uploadBar');
    const uploadStatus = modal.querySelector('#uploadStatus');
    const uploadedImages = modal.querySelector('#uploadedImages');
    const dropZone = modal.querySelector('#dropZone');
    
    // Drag and drop functionality
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });
    
    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      // Show progress
      uploadProgress.classList.remove('hidden');
      uploadBar.style.width = '0%';
      uploadStatus.textContent = `Processing ${files.length} image${files.length > 1 ? 's' : ''}...`;
      
      try {
        // Compress large images
        const maxSizeMB = 8;
        const processedFiles = [];
        let compressedCount = 0;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > maxSizeMB * 1024 * 1024) {
            uploadStatus.textContent = `Compressing image ${i + 1}/${files.length}...`;
            const compressed = await compressImage(file, maxSizeMB);
            processedFiles.push(compressed);
            compressedCount++;
          } else {
            processedFiles.push(file);
          }
        }
        
        if (compressedCount > 0) {
          uploadStatus.textContent = `Compressed ${compressedCount} image${compressedCount > 1 ? 's' : ''}. Uploading...`;
        } else {
          uploadStatus.textContent = `Uploading ${files.length} image${files.length > 1 ? 's' : ''}...`;
        }
        
        // Create FormData with processed files
        const formData = new FormData();
        for (let i = 0; i < processedFiles.length; i++) {
          formData.append('files', processedFiles[i]);
        }
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        uploadBar.style.width = '50%';
        
        const response = await fetch('/dashboard/gallery/api/upload/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrfToken
          }
        });
        
        uploadBar.style.width = '100%';
        
        const result = await response.json();
        
        if (result.success) {
          uploadStatus.textContent = `Successfully uploaded ${result.images.length} image${result.images.length > 1 ? 's' : ''}!`;
          uploadStatus.classList.add('text-green-600');
          
          // Display uploaded images with pre-selection
          uploadedImages.innerHTML = '';
          result.images.forEach(image => {
            const imgEl = document.createElement('div');
            imgEl.className = 'relative group cursor-pointer rounded-lg overflow-hidden border-2 border-blue-500 bg-blue-50 transition';
            imgEl.innerHTML = `
              <img src="${image.thumb_url || image.web_url}" alt="${image.title}" class="w-full h-24 object-cover">
              <div class="absolute inset-0 bg-blue-500 bg-opacity-20 transition flex items-center justify-center">
                <span class="text-white text-xs font-medium">Pre-selected</span>
                <div class="absolute top-1 right-1 w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center">
                  ‚úì
                </div>
              </div>
            `;
            imgEl.addEventListener('click', () => {
              if (currentTargetInput) {
                currentTargetInput.value = image.web_url || image.secure_url;
                currentTargetInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
              modal.classList.add('hidden');
            });
            uploadedImages.appendChild(imgEl);
            
            // Pre-select uploaded images for gallery selection
            const imageUrl = image.web_url || image.secure_url;
            // Note: selectedImages and updateButton will be available when the modal is properly set up
          });
          
          // Reload gallery to show new images and pre-select them
          loadGalleryImages().then(() => {
            // Pre-select the newly uploaded images
            result.images.forEach(image => {
              const imageUrl = image.web_url || image.secure_url;
              const galleryGrid = modal.querySelector('#galleryGrid');
              if (galleryGrid) {
                const galleryItems = galleryGrid.querySelectorAll('.relative.group.cursor-pointer');
                galleryItems.forEach(item => {
                  const img = item.querySelector('img');
                  if (img && img.src === imageUrl) {
                    // Pre-select this image
                    selectedImages.add(imageUrl);
                    item.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                    item.classList.remove('hover:border-gray-400');
                    // Add checkmark
                    const checkmark = document.createElement('div');
                    checkmark.className = 'selection-checkmark absolute top-1 right-1 w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center';
                    checkmark.innerHTML = '‚úì';
                    item.appendChild(checkmark);
                  }
                });
              }
            });
            updateButton();
          });
          
          // Reset after 3 seconds
          setTimeout(() => {
            uploadProgress.classList.add('hidden');
            uploadBar.style.width = '0%';
            uploadStatus.textContent = 'Uploading...';
            uploadStatus.classList.remove('text-green-600');
            fileInput.value = '';
          }, 3000);
        } else {
          uploadStatus.textContent = `Error: ${result.error}`;
          uploadStatus.classList.add('text-red-600');
        }
      } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.classList.add('text-red-600');
      }
    });
    
    return modal;
  }

  function loadGalleryImages() {
    const galleryGrid = document.getElementById('galleryGrid');
    console.log('loadGalleryImages called, galleryGrid:', galleryGrid);
    if (!galleryGrid) {
      console.error('galleryGrid not found!');
      return Promise.resolve();
    }
    
    console.log('Fetching gallery images...');
    return fetch('/dashboard/gallery/api/images/')
      .then(response => {
        console.log('Gallery API response:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Gallery API data:', data);
        galleryGrid.innerHTML = '';
        if (data.images && data.images.length > 0) {
          data.images.forEach(image => {
            const imgElement = document.createElement('div');
            imgElement.className = 'relative group cursor-pointer rounded-lg overflow-hidden border border-gray-200 hover:border-gray-400 transition';
            imgElement.innerHTML = `
              <img src="${image.thumb_url || image.web_url || image.secure_url}" 
                   alt="${image.title}" 
                   class="w-full h-32 object-cover">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition">
                <div class="absolute bottom-2 left-2 right-2 text-white text-xs opacity-0 group-hover:opacity-100 transition">
                  ${image.title}
                </div>
              </div>
            `;
            // Don't add the old click handler - we'll handle selection in the modal event listener
            galleryGrid.appendChild(imgElement);
          });
        } else {
          galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8">No images available</p>';
        }
      })
      .catch(error => {
        console.error('Error loading gallery images:', error);
        galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8">Error loading images</p>';
      });
  }

  // Function to open gallery for individual image selection
  function openImageGallery(targetInput) {
    console.log('Opening image gallery for:', targetInput);
    
    // Create gallery modal for single image selection
    const modal = document.createElement('div');
    modal.id = 'imageGalleryModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
    modal.innerHTML = `
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Select Image</h3>
            <button id="closeImageGallery" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6 overflow-y-auto max-h-[60vh]">
            <div id="imageGalleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <!-- Images will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Load gallery images
    loadImageGalleryImages(modal, targetInput);
    
    // Add close button functionality
    modal.querySelector('#closeImageGallery').addEventListener('click', () => {
      modal.remove();
    });
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  // Function to open gallery with upload tab for Before/After images
  function openImageGalleryWithUpload(targetInput) {
    console.log('Opening image gallery with upload for:', targetInput);
    
    // Create gallery modal with tabs
    const modal = document.createElement('div');
    modal.id = 'imageGalleryModalWithUpload';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
    modal.innerHTML = `
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Select or Upload Image</h3>
            <button class="closeModalBtn text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Tab Navigation -->
          <div class="flex border-b border-gray-200">
            <button class="modalTabBtn gallery-tab flex-1 px-6 py-3 text-sm font-medium text-gray-900 border-b-2 border-gray-900 bg-gray-50">
              üì∑ Gallery
            </button>
            <button class="modalTabBtn upload-tab flex-1 px-6 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-50">
              ‚¨ÜÔ∏è Upload
            </button>
          </div>
          
          <!-- Tab Content -->
          <div class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- Gallery Tab -->
            <div class="tab-content gallery-content">
              <div class="imageGalleryGrid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Images will be loaded here -->
              </div>
            </div>
            
            <!-- Upload Tab -->
            <div class="tab-content upload-content hidden">
              <div class="max-w-md mx-auto">
                <div class="uploadDropZone border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition">
                  <input type="file" class="imageUploadInput hidden" accept="image/*">
                  <div class="cursor-pointer uploadClickArea">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                      <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="mt-4">
                      <p class="text-sm font-medium text-gray-900">Upload Image</p>
                      <p class="text-xs text-gray-500">Click to select or drag and drop</p>
                      <p class="text-xs text-gray-400 mt-1">Supports: JPG, PNG, WebP (max 10MB)</p>
                    </div>
                  </div>
                </div>
                
                <div class="uploadProgress mt-4 hidden">
                  <div class="bg-gray-200 rounded-full h-2">
                    <div class="uploadBar bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <p class="uploadStatus text-sm text-gray-600 mt-2">Uploading...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Tab switching
    const galleryTab = modal.querySelector('.gallery-tab');
    const uploadTab = modal.querySelector('.upload-tab');
    const galleryContent = modal.querySelector('.gallery-content');
    const uploadContent = modal.querySelector('.upload-content');
    
    galleryTab.addEventListener('click', () => {
      galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.remove('text-gray-500', 'border-transparent');
      uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.add('text-gray-500', 'border-transparent');
      galleryContent.classList.remove('hidden');
      uploadContent.classList.add('hidden');
    });
    
    uploadTab.addEventListener('click', () => {
      uploadTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.remove('text-gray-500', 'border-transparent');
      galleryTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.add('text-gray-500', 'border-transparent');
      uploadContent.classList.remove('hidden');
      galleryContent.classList.add('hidden');
    });
    
    // Load gallery images
    const galleryGrid = modal.querySelector('.imageGalleryGrid');
    fetch('/dashboard/gallery/api/images/')
      .then(response => response.json())
      .then(data => {
        galleryGrid.innerHTML = '';
        if (data.images && data.images.length > 0) {
          data.images.forEach(image => {
            const imgElement = document.createElement('div');
            imgElement.className = 'relative group cursor-pointer rounded-lg overflow-hidden border border-gray-200 hover:border-gray-400 transition';
            imgElement.innerHTML = `
              <img src="${image.thumb_url || image.web_url || image.secure_url}" 
                   alt="${image.title}" 
                   class="w-full h-32 object-cover">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition">
                <div class="absolute bottom-2 left-2 right-2 text-white text-xs opacity-0 group-hover:opacity-100 transition">
                  ${image.title}
                </div>
              </div>
            `;
            imgElement.addEventListener('click', () => {
              if (targetInput) {
                targetInput.value = image.web_url || image.secure_url;
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
              modal.remove();
            });
            galleryGrid.appendChild(imgElement);
          });
        } else {
          galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No images available</p>';
        }
      })
      .catch(error => {
        console.error('Error loading gallery images:', error);
        galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">Error loading images</p>';
      });
    
    // Upload functionality
    const fileInput = modal.querySelector('.imageUploadInput');
    const uploadProgress = modal.querySelector('.uploadProgress');
    const uploadBar = modal.querySelector('.uploadBar');
    const uploadStatus = modal.querySelector('.uploadStatus');
    const dropZone = modal.querySelector('.uploadDropZone');
    const clickArea = modal.querySelector('.uploadClickArea');
    
    clickArea.addEventListener('click', () => fileInput.click());
    
    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });
    
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      uploadProgress.classList.remove('hidden');
      uploadBar.style.width = '0%';
      uploadStatus.textContent = 'Compressing image...';
      uploadStatus.className = 'uploadStatus text-sm text-gray-600 mt-2';
      
      try {
        // Compress image if it's too large
        const maxSizeMB = 8; // Target 8MB to be safe (max is 10MB)
        let processedFile = file;
        
        if (file.size > maxSizeMB * 1024 * 1024) {
          uploadStatus.textContent = `Compressing ${(file.size / 1024 / 1024).toFixed(1)}MB image...`;
          processedFile = await compressImage(file, maxSizeMB);
          uploadStatus.textContent = `Compressed to ${(processedFile.size / 1024 / 1024).toFixed(1)}MB. Uploading...`;
        } else {
          uploadStatus.textContent = 'Uploading...';
        }
        
        uploadBar.style.width = '30%';
        
        const formData = new FormData();
        formData.append('file', processedFile);
        
        uploadBar.style.width = '50%';
        
        const response = await fetch('/u/editor-image/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });
        
        uploadBar.style.width = '100%';
        
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.url) {
          uploadStatus.textContent = 'Upload successful!';
          uploadStatus.classList.add('text-green-600');
          
          if (targetInput) {
            targetInput.value = data.web_url || data.url;
            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
          
          setTimeout(() => {
            modal.remove();
          }, 1000);
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.classList.add('text-red-600');
      }
    });
    
    // Close button
    modal.querySelector('.closeModalBtn').addEventListener('click', () => {
      modal.remove();
    });
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  function loadImageGalleryImages(modal, targetInput) {
    const galleryGrid = modal.querySelector('#imageGalleryGrid');
    if (!galleryGrid) return;
    
    fetch('/dashboard/gallery/api/images/')
      .then(response => response.json())
      .then(data => {
        galleryGrid.innerHTML = '';
        if (data.images && data.images.length > 0) {
          data.images.forEach(image => {
            const imgElement = document.createElement('div');
            imgElement.className = 'relative group cursor-pointer rounded-lg overflow-hidden border border-gray-200 hover:border-gray-400 transition';
            imgElement.innerHTML = `
              <img src="${image.thumb_url || image.web_url || image.secure_url}" 
                   alt="${image.title}" 
                   class="w-full h-32 object-cover">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition">
                <div class="absolute bottom-2 left-2 right-2 text-white text-xs opacity-0 group-hover:opacity-100 transition">
                  ${image.title}
                </div>
              </div>
            `;
            imgElement.addEventListener('click', () => {
              if (targetInput) {
                targetInput.value = image.web_url || image.secure_url;
                // Trigger input event to update previews
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
              modal.remove();
            });
            galleryGrid.appendChild(imgElement);
          });
        } else {
          galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8">No images available</p>';
        }
      })
      .catch(error => {
        console.error('Error loading gallery images:', error);
        galleryGrid.innerHTML = '<p class="text-gray-500 text-center py-8">Error loading images</p>';
      });
  }

  // Add gallery button event listeners
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('gallery-btn-hero')) {
      const heroInput = document.querySelector('input[name="hero_media_url"]');
      openImageGallery(heroInput);
    } else if (e.target.classList.contains('gallery-btn-image')) {
      const imageInput = e.target.parentElement.querySelector('input[type="url"]');
      openImageGalleryWithUpload(imageInput);
    } else if (e.target.classList.contains('gallery-btn-thumb')) {
      const thumbInput = e.target.parentElement.querySelector('input[name$="-thumb_url"]');
      openImageGallery(thumbInput);
    } else if (e.target.classList.contains('gallery-btn-full')) {
      const fullInput = e.target.parentElement.querySelector('input[name$="-full_url"]');
      openImageGallery(fullInput);
    } else if (e.target.classList.contains('gallery-btn-case-study')) {
      const caseStudyInput = e.target.parentElement.querySelector('input[name$="-hero_image_url"]');
      openImageGallery(caseStudyInput);
    }
  });

  // ----------------- Dirty flag -----------------
  const dirtyEl = document.getElementById('dirtyFlag'); let dirty=false, timer;
  function setDirty(v){ dirty=v; if(dirtyEl) dirtyEl.textContent = v ? 'Unsaved changes‚Ä¶' : 'All changes saved'; }
  document.querySelector('form').addEventListener('input', ()=> setDirty(true));
  document.querySelector('form').addEventListener('submit', (e)=>{ 
    clearTimeout(timer); 
    if(dirtyEl) dirtyEl.textContent='Saving‚Ä¶'; 
    timer=setTimeout(()=>{
      setDirty(false);
      // Auto-refresh gallery images after successful save
      setTimeout(() => {
        const caseStudyForms = document.querySelectorAll('.case-study-form');
        caseStudyForms.forEach(form => {
          const galleryPreview = form.querySelector('.gallery-preview');
          const hiddenInput = form.querySelector('input[name*="gallery_urls"]');
          
          if (hiddenInput && hiddenInput.value) {
            try {
              const galleryUrls = JSON.parse(hiddenInput.value);
              if (galleryUrls.length > 0) {
                // Clear and reload gallery preview
                galleryPreview.innerHTML = '';
                galleryUrls.forEach(imageData => {
                  const previewItem = document.createElement('div');
                  previewItem.className = 'relative group';
                  previewItem.innerHTML = `
                    <img src="${imageData.thumb || imageData.full}" alt="Gallery image" class="w-full h-16 object-cover rounded border border-gray-200" data-full-url="${imageData.full}" data-thumb-url="${imageData.thumb || imageData.full}">
                    <button type="button" class="remove-gallery-item absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full hover:bg-red-600 transition-all duration-200 hover:scale-110" title="Remove image" style="display: none;">√ó</button>
                  `;
                  galleryPreview.appendChild(previewItem);
                });
              }
            } catch (e) {
              console.error('Error parsing gallery URLs after save:', e);
            }
          }
        });
      }, 1000);
    }, 800);
    
    // Debug: Log form data being submitted
    const formData = new FormData(e.target);
    console.group('Form Submission Debug');
    console.log('Total form entries:', Array.from(formData.entries()).length);
    
    // Log image formset data
    const imageFields = Array.from(formData.entries()).filter(([key]) => key.startsWith('images-'));
    console.log('Image formset fields:', imageFields.length);
    imageFields.forEach(([key, value]) => {
      if (value) console.log(`  ${key}: ${value}`);
    });
    
    // Log project image formset data
    const projectImageFields = Array.from(formData.entries()).filter(([key]) => key.startsWith('project_images-'));
    console.log('Project image formset fields:', projectImageFields.length);
    projectImageFields.forEach(([key, value]) => {
      if (value) console.log(`  ${key}: ${value}`);
    });
    
    // Log case study formset data
    const caseStudyFields = Array.from(formData.entries()).filter(([key]) => key.startsWith('case_studies-'));
    console.log('Case study formset fields:', caseStudyFields.length);
    caseStudyFields.forEach(([key, value]) => {
      if (value) console.log(`  ${key}: ${value}`);
    });
    
    console.groupEnd();
  });
  
  // Gallery upload for case studies
  console.log('üîß Setting up gallery upload event listener...');
  
  // ============================================
  // BEFORE/AFTER IMAGE UPLOAD
  // ============================================
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('beforeafter-upload-btn') || e.target.closest('.beforeafter-upload-btn')) {
      e.preventDefault();
      const btn = e.target.classList.contains('beforeafter-upload-btn') ? e.target : e.target.closest('.beforeafter-upload-btn');
      const imageForm = btn.closest('.image-form');
      const urlInput = imageForm.querySelector('input[name*="image_url"]');
      
      console.log('üì∏ Before/After upload button clicked');
      
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;
        
        console.log('üìÅ File selected:', file.name, `(${(file.size / 1024 / 1024).toFixed(1)}MB)`);
        
        // Show loading state
        btn.disabled = true;
        
        try {
          // Compress image if it's too large
          const maxSizeMB = 8;
          let processedFile = file;
          
          if (file.size > maxSizeMB * 1024 * 1024) {
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Compressing...';
            processedFile = await compressImage(file, maxSizeMB);
            console.log('üì¶ Compressed to:', `${(processedFile.size / 1024 / 1024).toFixed(1)}MB`);
          }
          
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Uploading...';
          
          const formData = new FormData();
          formData.append('file', processedFile);
          
          const response = await fetch('/u/editor-image/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });
          
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.url) {
            console.log('‚úÖ Upload successful:', data.url);
            urlInput.value = data.web_url || data.url;
            urlInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Update preview
            const preview = imageForm.querySelector('.imagePreview');
            if (preview) {
              preview.src = data.web_url || data.url;
              preview.style.opacity = '1';
              const emptyState = imageForm.querySelector('.imageEmpty');
              if (emptyState) emptyState.style.display = 'none';
            }
            
            btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Uploaded!';
            btn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            btn.classList.add('bg-green-600');
            
            setTimeout(() => {
              btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-1"></i> Upload Image';
              btn.classList.remove('bg-green-600');
              btn.classList.add('bg-teal-600', 'hover:bg-teal-700');
              btn.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.error || 'Upload failed');
          }
        } catch (error) {
          console.error('‚ùå Upload error:', error);
          alert('Upload failed: ' + error.message);
          btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-1"></i> Upload Image';
          btn.disabled = false;
        }
      });
      
      fileInput.click();
    }
  });
  
  // Check if gallery upload buttons exist
  const galleryButtons = document.querySelectorAll('.gallery-upload-btn');
  console.log('üîç Found gallery upload buttons:', galleryButtons.length);
  galleryButtons.forEach((btn, index) => {
    console.log(`  Button ${index}:`, btn);
    console.log(`  Button ${index} text:`, btn.textContent);
    console.log(`  Button ${index} classes:`, btn.className);
  });
  
  // Check if case study forms exist
  const caseStudyForms = document.querySelectorAll('.case-study-form');
  console.log('üîç Found case study forms:', caseStudyForms.length);
  caseStudyForms.forEach((form, index) => {
    const galleryBtn = form.querySelector('.gallery-upload-btn');
    console.log(`  Form ${index} has gallery button:`, !!galleryBtn);
    
    if (galleryBtn) {
      console.log(`  Form ${index} gallery button text:`, galleryBtn.textContent);
      console.log(`  Form ${index} gallery button classes:`, galleryBtn.className);
    }
    
    // Add event listeners for both gallery buttons
    const galleryEditBtn = form.querySelector('.gallery-edit-btn');
    const galleryUploadBtn = form.querySelector('.gallery-upload-btn');
    
    if (galleryEditBtn) {
      console.log(`  Adding edit listener to form ${index}`);
      galleryEditBtn.addEventListener('click', function(e) {
        console.log('üéØ Gallery edit button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        const galleryPreview = form.querySelector('.gallery-preview');
        toggleGalleryEditMode(galleryPreview, galleryEditBtn);
      });
    }
    
    if (galleryUploadBtn) {
      console.log(`  Adding upload listener to form ${index}`);
      galleryUploadBtn.addEventListener('click', function(e) {
        console.log('üéØ Gallery upload button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        const galleryPreview = form.querySelector('.gallery-preview');
        console.log('Gallery preview found:', galleryPreview);
        
        // Create and show gallery modal
        const modal = createGalleryModal();
        if (!modal) {
          console.error('Failed to create gallery modal!');
          return;
        }
        modal.style.zIndex = '9999';
        document.body.appendChild(modal);
        modal.classList.remove('hidden');
        
        // Set up the modal for this specific case study
        setupGalleryModal(modal, form, galleryPreview);
      });
    }
    
    if (!galleryEditBtn && !galleryUploadBtn) {
      console.log(`  ‚ùå Form ${index} has NO gallery buttons!`);
    }
  });
  
  // Function to toggle gallery edit mode
  function toggleGalleryEditMode(galleryPreview, editBtn) {
    const isEditMode = galleryPreview.classList.contains('edit-mode');
    
    if (isEditMode) {
      // Exit edit mode
      galleryPreview.classList.remove('edit-mode');
      editBtn.textContent = '‚úèÔ∏è Edit Gallery';
      editBtn.classList.remove('bg-blue-600', 'text-white');
      editBtn.classList.add('border-gray-300', 'hover:bg-gray-50');
      
      // Hide all X buttons
      const removeButtons = galleryPreview.querySelectorAll('.remove-gallery-item');
      removeButtons.forEach(btn => {
        btn.style.display = 'none';
      });
      
      console.log('üìù Exited gallery edit mode');
    } else {
      // Enter edit mode
      galleryPreview.classList.add('edit-mode');
      editBtn.textContent = '‚úÖ Done Editing';
      editBtn.classList.add('bg-blue-600', 'text-white');
      editBtn.classList.remove('border-gray-300', 'hover:bg-gray-50');
      
      // Show all X buttons and add event listeners
      const removeButtons = galleryPreview.querySelectorAll('.remove-gallery-item');
      removeButtons.forEach(btn => {
        btn.style.display = 'block';
        
        // Add click event listener if not already added
        if (!btn.hasAttribute('data-listener-added')) {
          btn.addEventListener('click', function(e) {
            console.log('üóëÔ∏è X button clicked!');
            e.preventDefault();
            e.stopPropagation();
            
            // Visual feedback - make button flash
            btn.style.background = 'darkred';
            btn.textContent = 'üóëÔ∏è';
            setTimeout(() => {
              btn.style.background = 'red';
              btn.textContent = '√ó';
            }, 200);
            
            const itemToRemove = btn.closest('.group');
            console.log('Item to remove:', itemToRemove);
            
            if (itemToRemove) {
              itemToRemove.remove();
              console.log('‚úÖ Image removed successfully!');
              
              // Update hidden input
              const caseStudyForm = galleryPreview.closest('.case-study-form');
              const hiddenInput = caseStudyForm.querySelector('input[name*="gallery_urls"]');
              if (hiddenInput) {
                const currentUrls = JSON.parse(hiddenInput.value || '[]');
                const imgSrc = itemToRemove.querySelector('img').src;
                const updatedUrls = currentUrls.filter(url => url.full !== imgSrc);
                hiddenInput.value = JSON.stringify(updatedUrls);
                console.log('‚úÖ Hidden input updated');
              }
              
              // Show "No gallery images" message if no images left
              if (galleryPreview.children.length === 0) {
                galleryPreview.innerHTML = '<div class="text-xs text-gray-500 text-center py-4 col-span-3">No gallery images</div>';
              }
            }
          });
          
          btn.setAttribute('data-listener-added', 'true');
        }
      });
      
      console.log('üìù Entered gallery edit mode');
    }
  }
  
  // Function to set up gallery modal
  function setupGalleryModal(modal, caseStudyForm, galleryPreview) {
    console.log('üîß Setting up gallery modal...');
    
    // Set up tab switching
    const galleryTab = modal.querySelector('#galleryTab');
    const uploadTab = modal.querySelector('#uploadTab');
    const galleryTabContent = modal.querySelector('#galleryTabContent');
    const uploadTabContent = modal.querySelector('#uploadTabContent');
    
    // Switch to gallery tab by default
    galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
    galleryTab.classList.remove('text-gray-500', 'border-transparent');
    uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
    uploadTab.classList.add('text-gray-500', 'border-transparent');
    galleryTabContent.classList.remove('hidden');
    uploadTabContent.classList.add('hidden');
    
    // Add tab switching functionality
    galleryTab.addEventListener('click', () => {
      galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.remove('text-gray-500', 'border-transparent');
      uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.add('text-gray-500', 'border-transparent');
      galleryTabContent.classList.remove('hidden');
      uploadTabContent.classList.add('hidden');
    });
    
    uploadTab.addEventListener('click', () => {
      uploadTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.remove('text-gray-500', 'border-transparent');
      galleryTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.add('text-gray-500', 'border-transparent');
      uploadTabContent.classList.remove('hidden');
      galleryTabContent.classList.add('hidden');
    });
    
    // Load gallery images
    loadGalleryImages();
    
    // Add close button functionality
    const closeBtn = modal.querySelector('#closeGallery');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        modal.remove();
      });
    }
    
    // Handle image selection for this case study - support multiple selection
    const selectedImages = new Set();
    
    // Function to update the "Add Selected" button
    const updateButton = () => {
      const btn = modal.querySelector('#addSelectedImages');
      if (btn) {
        const count = selectedImages.size;
        btn.textContent = `Add Selected Images (${count})`;
        btn.disabled = count === 0;
        btn.className = count > 0 
          ? 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700' 
          : 'px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed';
      }
    };
    
    // Add click handler to the gallery grid specifically
    const galleryGrid = modal.querySelector('#galleryGrid');
    if (galleryGrid) {
      galleryGrid.addEventListener('click', function(e) {
        // Check if clicked on a gallery image (either the img or its container)
        const galleryItem = e.target.closest('.relative.group.cursor-pointer');
        if (galleryItem) {
          const img = galleryItem.querySelector('img');
          if (img) {
            const fullUrl = img.src; // Use the full URL from the image src
            const imageId = fullUrl; // Use URL as unique identifier
            
            console.log('Image clicked:', imageId);
            
            // Toggle selection with enhanced visual feedback
            if (selectedImages.has(imageId)) {
              selectedImages.delete(imageId);
              galleryItem.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
              galleryItem.classList.add('hover:border-gray-400');
              // Remove checkmark
              const checkmark = galleryItem.querySelector('.selection-checkmark');
              if (checkmark) checkmark.remove();
              console.log('Image deselected:', imageId);
            } else {
              selectedImages.add(imageId);
              galleryItem.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
              galleryItem.classList.remove('hover:border-gray-400');
              // Add checkmark
              const checkmark = document.createElement('div');
              checkmark.className = 'selection-checkmark absolute top-1 right-1 w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center';
              checkmark.innerHTML = '‚úì';
              galleryItem.appendChild(checkmark);
              console.log('Image selected:', imageId);
            }
            
            // Update button
            updateButton();
          }
        }
      });
    }
    
    // Add "Add Selected" button to modal
    const modalContent = modal.querySelector('.p-6');
    const addSelectedBtn = document.createElement('div');
    addSelectedBtn.className = 'mt-4 text-center';
    addSelectedBtn.innerHTML = `
      <button type="button" id="addSelectedImages" class="px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed">
        Add Selected Images (0)
      </button>
    `;
    modalContent.appendChild(addSelectedBtn);
    
    // Update button initially
    updateButton();
    
    // Handle "Add Selected" button click
    modal.querySelector('#addSelectedImages').addEventListener('click', function() {
      if (selectedImages.size === 0) return;
      
      // Get current gallery URLs - find the hidden input for gallery_urls
      const hiddenInput = caseStudyForm.querySelector('input[name*="gallery_urls"]');
      let currentUrls = [];
      if (hiddenInput && hiddenInput.value) {
        try {
          currentUrls = JSON.parse(hiddenInput.value);
        } catch (e) {
          currentUrls = [];
        }
      }
      
      // Add selected images
      selectedImages.forEach(imageUrl => {
        const newImage = {full: imageUrl, thumb: imageUrl};
        currentUrls.push(newImage);
        
        // Add to gallery preview
        const previewItem = document.createElement('div');
        previewItem.className = 'relative group';
        previewItem.innerHTML = `
          <img src="${imageUrl}" alt="Gallery image" class="w-full h-16 object-cover rounded border border-gray-200" data-full-url="${imageUrl}" data-thumb-url="${imageUrl}">
          <button type="button" class="remove-gallery-item absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full hover:bg-red-600 transition-all duration-200 hover:scale-110" title="Remove image" style="display: none;">√ó</button>
        `;
        
        // Remove "No gallery images" message if it exists
        const noImagesMsg = galleryPreview.querySelector('.text-gray-500');
        if (noImagesMsg) noImagesMsg.remove();
        
        galleryPreview.appendChild(previewItem);
      });
      
      // Update hidden input
      if (hiddenInput) {
        hiddenInput.value = JSON.stringify(currentUrls);
      }
      
      modal.remove();
    });
    
    // Handle gallery item removal
    galleryPreview.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-gallery-item')) {
        console.log('üóëÔ∏è Remove button clicked!');
        const itemToRemove = e.target.closest('.group');
        console.log('Item to remove:', itemToRemove);
        itemToRemove.remove();
        
        // Update hidden input
        const hiddenInput = caseStudyForm.querySelector('input[name*="gallery_urls"]');
        if (hiddenInput) {
          const currentUrls = JSON.parse(hiddenInput.value || '[]');
          const imgSrc = itemToRemove.querySelector('img').src;
          const updatedUrls = currentUrls.filter(url => url.full !== imgSrc);
          hiddenInput.value = JSON.stringify(updatedUrls);
        }
        
        // Show "No gallery images" message if no images left
        if (galleryPreview.children.length === 0) {
          galleryPreview.innerHTML = '<div class="text-xs text-gray-500 text-center py-4 col-span-3">No gallery images</div>';
        }
      }
    });
  }
  
  document.addEventListener('click', function(e) {
    console.log('üñ±Ô∏è Click detected on:', e.target);
    console.log('üñ±Ô∏è Target classes:', e.target.className);
    if (e.target.classList.contains('gallery-upload-btn')) {
      console.log('üéØ Gallery upload button clicked!');
      
      const caseStudyForm = e.target.closest('.case-study-form');
      const galleryPreview = caseStudyForm.querySelector('.gallery-preview');
      
      console.log('Case study form found:', caseStudyForm);
      console.log('Gallery preview found:', galleryPreview);
      
      // Create gallery modal for this specific case study
      console.log('Creating gallery modal...');
      const modal = createGalleryModal();
      if (!modal) {
        console.error('Failed to create gallery modal!');
        return;
      }
      modal.style.zIndex = '9999';
      document.body.appendChild(modal);
      
      // Show the modal
      modal.classList.remove('hidden');
      console.log('Modal should be visible now');
      
      // Set up tab switching
      const galleryTab = modal.querySelector('#galleryTab');
      const uploadTab = modal.querySelector('#uploadTab');
      const galleryTabContent = modal.querySelector('#galleryTabContent');
      const uploadTabContent = modal.querySelector('#uploadTabContent');
      
      console.log('Modal elements found:');
      console.log('galleryTab:', galleryTab);
      console.log('uploadTab:', uploadTab);
      console.log('galleryTabContent:', galleryTabContent);
      console.log('uploadTabContent:', uploadTabContent);
      
      // Switch to gallery tab by default
      galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
      galleryTab.classList.remove('text-gray-500', 'border-transparent');
      uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
      uploadTab.classList.add('text-gray-500', 'border-transparent');
      galleryTabContent.classList.remove('hidden');
      uploadTabContent.classList.add('hidden');
      
      // Add tab switching functionality
      galleryTab.addEventListener('click', () => {
        galleryTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
        galleryTab.classList.remove('text-gray-500', 'border-transparent');
        uploadTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
        uploadTab.classList.add('text-gray-500', 'border-transparent');
        galleryTabContent.classList.remove('hidden');
        uploadTabContent.classList.add('hidden');
      });
      
      uploadTab.addEventListener('click', () => {
        uploadTab.classList.add('text-gray-900', 'border-gray-900', 'bg-gray-50');
        uploadTab.classList.remove('text-gray-500', 'border-transparent');
        galleryTab.classList.remove('text-gray-900', 'border-gray-900', 'bg-gray-50');
        galleryTab.classList.add('text-gray-500', 'border-transparent');
        uploadTabContent.classList.remove('hidden');
        galleryTabContent.classList.add('hidden');
      });
      
      // Load gallery images
      loadGalleryImages();
      
      // Add close button functionality
      const closeBtn = modal.querySelector('#closeGallery');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          modal.remove();
        });
      }
      
      // Handle image selection for this case study - support multiple selection
      const selectedImages = new Set();
      
      // Function to update the "Add Selected" button
      const updateButton = () => {
        const btn = modal.querySelector('#addSelectedImages');
        if (btn) {
          const count = selectedImages.size;
          btn.textContent = `Add Selected Images (${count})`;
          btn.disabled = count === 0;
          btn.className = count > 0 
            ? 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700' 
            : 'px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed';
        }
      };
      
      // Add click handler to the gallery grid specifically
      const galleryGrid = modal.querySelector('#galleryGrid');
      if (galleryGrid) {
        galleryGrid.addEventListener('click', function(e) {
          // Check if clicked on a gallery image (either the img or its container)
          const galleryItem = e.target.closest('.relative.group.cursor-pointer');
          if (galleryItem) {
            const img = galleryItem.querySelector('img');
            if (img) {
              const fullUrl = img.src; // Use the full URL from the image src
              const thumbUrl = img.src; // Same for thumb since we're using the same URL
              const imageId = fullUrl; // Use URL as unique identifier
              
              console.log('Image clicked:', imageId);
              
              // Toggle selection with enhanced visual feedback
              if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                galleryItem.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                galleryItem.classList.add('hover:border-gray-400');
                // Remove checkmark
                const checkmark = galleryItem.querySelector('.selection-checkmark');
                if (checkmark) checkmark.remove();
                console.log('Image deselected:', imageId);
              } else {
                selectedImages.add(imageId);
                galleryItem.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                galleryItem.classList.remove('hover:border-gray-400');
                // Add checkmark
                const checkmark = document.createElement('div');
                checkmark.className = 'selection-checkmark absolute top-1 right-1 w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center';
                checkmark.innerHTML = '‚úì';
                galleryItem.appendChild(checkmark);
                console.log('Image selected:', imageId);
              }
              
              // Update button
              updateButton();
            }
          }
        });
      }
      
      // updateButton function is already defined above
      
      // Add "Add Selected" button to modal
      const modalContent = modal.querySelector('.p-6');
      const addSelectedBtn = document.createElement('div');
      addSelectedBtn.className = 'mt-4 text-center';
      addSelectedBtn.innerHTML = `
        <button type="button" id="addSelectedImages" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
          Add Selected Images (0)
        </button>
      `;
      modalContent.appendChild(addSelectedBtn);
      
      // Update button initially
      updateButton();
      
      // Handle "Add Selected" button click
      modal.querySelector('#addSelectedImages').addEventListener('click', function() {
        if (selectedImages.size === 0) return;
        
        // Get current gallery URLs - find the hidden input for gallery_urls
        const hiddenInput = caseStudyForm.querySelector('input[name*="gallery_urls"]');
        let currentUrls = [];
        if (hiddenInput && hiddenInput.value) {
          try {
            currentUrls = JSON.parse(hiddenInput.value);
          } catch (e) {
            currentUrls = [];
          }
        }
        
        // Add selected images
        selectedImages.forEach(imageUrl => {
          const newImage = {full: imageUrl, thumb: imageUrl};
          currentUrls.push(newImage);
          
          // Add to gallery preview
          const previewItem = document.createElement('div');
          previewItem.className = 'relative group';
          previewItem.innerHTML = `
            <img src="${imageUrl}" alt="Gallery image" class="w-full h-16 object-cover rounded border border-gray-200" data-full-url="${imageUrl}" data-thumb-url="${imageUrl}">
            <button type="button" class="remove-gallery-item absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full hover:bg-red-600 transition-all duration-200 hover:scale-110" title="Remove image">√ó</button>
          `;
          
          // Remove "No gallery images" message if it exists
          const noImagesMsg = galleryPreview.querySelector('.text-gray-500');
          if (noImagesMsg) noImagesMsg.remove();
          
          galleryPreview.appendChild(previewItem);
        });
        
        // Update hidden input
        if (hiddenInput) {
          hiddenInput.value = JSON.stringify(currentUrls);
        }
        
        modal.remove();
      });
      
      // Handle gallery item removal
      galleryPreview.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-gallery-item')) {
          console.log('üóëÔ∏è Remove button clicked!');
          const itemToRemove = e.target.closest('.group');
          console.log('Item to remove:', itemToRemove);
          itemToRemove.remove();
          
          // Update hidden input
          const hiddenInput = caseStudyForm.querySelector('input[name*="gallery_urls"]');
          if (hiddenInput) {
            const currentUrls = JSON.parse(hiddenInput.value || '[]');
            const imgSrc = itemToRemove.querySelector('img').src;
            const updatedUrls = currentUrls.filter(url => url.full !== imgSrc);
            hiddenInput.value = JSON.stringify(updatedUrls);
          }
          
          // Show "No gallery images" message if no images left
          if (galleryPreview.children.length === 0) {
            galleryPreview.innerHTML = '<div class="text-xs text-gray-500 text-center py-4 col-span-3">No gallery images</div>';
          }
        }
      });
    }
  });
});

// Load existing gallery images when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Find all case study forms and load their gallery images
  const caseStudyForms = document.querySelectorAll('.case-study-form');
  caseStudyForms.forEach(form => {
    const galleryPreview = form.querySelector('.gallery-preview');
    const hiddenInput = form.querySelector('input[name*="gallery_urls"]');
    
    if (hiddenInput && hiddenInput.value) {
      try {
        const galleryUrls = JSON.parse(hiddenInput.value);
        if (galleryUrls.length > 0) {
          // Clear "No gallery images" message
          const noImagesMsg = galleryPreview.querySelector('.text-gray-500');
          if (noImagesMsg) noImagesMsg.remove();
          
          // Add existing images to preview
          galleryUrls.forEach(imageData => {
            const previewItem = document.createElement('div');
            previewItem.className = 'relative group';
            previewItem.innerHTML = `
              <img src="${imageData.thumb || imageData.full}" alt="Gallery image" class="w-full h-16 object-cover rounded border border-gray-200" data-full-url="${imageData.full}" data-thumb-url="${imageData.thumb || imageData.full}">
              <button type="button" class="remove-gallery-item absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full hover:bg-red-600 transition-all duration-200 hover:scale-110" title="Remove image" style="display: none;">√ó</button>
            `;
            galleryPreview.appendChild(previewItem);
          });
        }
      } catch (e) {
        console.error('Error parsing gallery URLs:', e);
      }
    }
  });
});

// ============================================
// ICON PICKER FOR SERVICE CAPABILITIES
// ============================================

// Common service icons (Font Awesome 6 solid icons)
const SERVICE_ICONS = [
  { class: 'fa-solid fa-hammer', label: 'Hammer' },
  { class: 'fa-solid fa-wrench', label: 'Wrench' },
  { class: 'fa-solid fa-screwdriver-wrench', label: 'Tools' },
  { class: 'fa-solid fa-paintbrush', label: 'Paint Brush' },
  { class: 'fa-solid fa-brush', label: 'Brush' },
  { class: 'fa-solid fa-paint-roller', label: 'Paint Roller' },
  { class: 'fa-solid fa-tree', label: 'Tree' },
  { class: 'fa-solid fa-seedling', label: 'Plant' },
  { class: 'fa-solid fa-water', label: 'Water' },
  { class: 'fa-solid fa-droplet', label: 'Droplet' },
  { class: 'fa-solid fa-person-swimming', label: 'Pool' },
  { class: 'fa-solid fa-building', label: 'Building' },
  { class: 'fa-solid fa-house', label: 'House' },
  { class: 'fa-solid fa-chair', label: 'Furniture' },
  { class: 'fa-solid fa-couch', label: 'Couch' },
  { class: 'fa-solid fa-bed', label: 'Bed' },
  { class: 'fa-solid fa-kitchen-set', label: 'Kitchen' },
  { class: 'fa-solid fa-door-open', label: 'Door' },
  { class: 'fa-solid fa-stairs', label: 'Stairs' },
  { class: 'fa-solid fa-lightbulb', label: 'Light' },
  { class: 'fa-solid fa-bolt', label: 'Electric' },
  { class: 'fa-solid fa-plug', label: 'Plug' },
  { class: 'fa-solid fa-fire-flame-simple', label: 'Fire' },
  { class: 'fa-solid fa-temperature-half', label: 'HVAC' },
  { class: 'fa-solid fa-wind', label: 'Air' },
  { class: 'fa-solid fa-toolbox', label: 'Toolbox' },
  { class: 'fa-solid fa-trowel-bricks', label: 'Masonry' },
  { class: 'fa-solid fa-ruler-combined', label: 'Measure' },
  { class: 'fa-solid fa-compass-drafting', label: 'Design' },
  { class: 'fa-solid fa-pencil', label: 'Draw' },
  { class: 'fa-solid fa-broom', label: 'Cleaning' },
  { class: 'fa-solid fa-spray-can', label: 'Spray' },
  { class: 'fa-solid fa-hand-sparkles', label: 'Clean Hands' },
  { class: 'fa-solid fa-clipboard-check', label: 'Checklist' },
  { class: 'fa-solid fa-chart-line', label: 'Analytics' },
  { class: 'fa-solid fa-clock', label: 'Time' },
  { class: 'fa-solid fa-calendar', label: 'Schedule' },
  { class: 'fa-solid fa-shield-halved', label: 'Security' },
  { class: 'fa-solid fa-certificate', label: 'Certificate' },
  { class: 'fa-solid fa-award', label: 'Award' },
  { class: 'fa-solid fa-star', label: 'Star' },
  { class: 'fa-solid fa-check-circle', label: 'Check' },
  { class: 'fa-solid fa-circle-check', label: 'Verified' },
];

let currentIconInput = null;

function openIconPicker(inputElement) {
  currentIconInput = inputElement;
  
  // Check if modal already exists
  let modal = document.getElementById('iconPickerModal');
  if (!modal) {
    // Create modal
    modal = document.createElement('div');
    modal.id = 'iconPickerModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.style.display = 'none';
    
    modal.innerHTML = `
      <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-teal-50 to-white">
          <div>
            <h3 class="text-xl font-bold text-gray-900">Choose an Icon</h3>
            <p class="text-sm text-gray-600 mt-1">Select an icon for your service capability</p>
          </div>
          <button type="button" onclick="closeIconPicker()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3" id="iconGrid">
            ${SERVICE_ICONS.map(icon => `
              <button type="button" 
                      onclick="selectIcon('${icon.class}')" 
                      class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-gray-200 hover:border-teal-500 hover:bg-teal-50 transition-all duration-200 group"
                      title="${icon.label}">
                <i class="${icon.class} text-2xl text-gray-700 group-hover:text-teal-600 transition-colors"></i>
                <span class="text-xs text-gray-600 text-center leading-tight">${icon.label}</span>
              </button>
            `).join('')}
          </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 text-center">
          <p class="text-xs text-gray-500">
            Can't find what you need? You can manually enter any Font Awesome class in the input field.
          </p>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on background click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeIconPicker();
      }
    });
  }
  
  modal.style.display = 'flex';
}

function closeIconPicker() {
  const modal = document.getElementById('iconPickerModal');
  if (modal) {
    modal.style.display = 'none';
  }
  currentIconInput = null;
}

function selectIcon(iconClass) {
  if (currentIconInput) {
    currentIconInput.value = iconClass;
    
    // Update preview if it exists
    const preview = currentIconInput.closest('div').querySelector('i');
    if (preview) {
      preview.className = iconClass + ' text-teal-600';
    }
    
    // Trigger change event
    currentIconInput.dispatchEvent(new Event('change', { bubbles: true }));
  }
  closeIconPicker();
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeIconPicker();
  }
});
</script>
{% endblock %}
