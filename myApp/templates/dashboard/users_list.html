{% extends "dashboard/base.html" %}
{% block page_title %}Users{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6 flex items-center justify-between">
  <div>
    <div class="text-xs uppercase tracking-widest text-gray-500">User Management</div>
    <h1 class="text-2xl font-semibold text-gray-900">Users</h1>
  </div>
  <div class="flex items-center gap-2">
    <a href="{% url 'dashboard_user_create' %}"
       class="inline-flex items-center gap-2 rounded-xl bg-gray-900 px-4 py-2 text-white hover:bg-black transition">
      <!-- plus icon -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 4v16m8-8H4"/></svg>
      New User
    </a>
  </div>
</div>

<!-- Toolbar -->
<div class="mb-4 rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="flex items-center gap-2">
      <!-- search -->
      <div class="relative">
        <input id="searchInput" type="search" placeholder="Search users…"
               class="w-64 rounded-xl border border-gray-300 pl-9 pr-3 py-2 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-900/10 focus:border-gray-400 transition">
        <svg class="pointer-events-none absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="m21 21-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"/></svg>
      </div>

      <!-- role filter -->
      <select id="roleFilter"
              class="rounded-xl border border-gray-300 px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-900/10 focus:border-gray-400 transition">
        <option value="all">All roles</option>
        <option value="admin">Admin</option>
        <option value="blog_author">Blog Author</option>
        <option value="user">Regular User</option>
      </select>
    </div>

    <!-- view toggle (cards/table) -->
    <div class="flex items-center gap-1">
      <button id="viewCardsBtn" type="button"
              class="viewbtn px-3 py-1.5 text-sm rounded-lg border border-gray-300 bg-gray-900 text-white">Cards</button>
      <button id="viewTableBtn" type="button"
              class="viewbtn px-3 py-1.5 text-sm rounded-lg border border-gray-300">Table</button>
    </div>
  </div>
</div>

<!-- Cards view -->
<div id="cardsView" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
  {% for user in users %}
  <article
    class="user-card group overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm transition hover:shadow-md"
    data-username="{{ user.username|lower }}" data-role="{{ user.profile.role|default:'user' }}"
    data-email="{{ user.email|default:''|lower }}">
    <!-- avatar -->
    <div class="relative aspect-[16/9] bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center">
      <div class="w-16 h-16 rounded-full bg-indigo-600 flex items-center justify-center text-white text-xl font-semibold">
        {{ user.username|first|upper }}
      </div>
      {% if user.is_superuser %}
        <span class="absolute right-3 top-3 inline-flex items-center gap-1 rounded-full bg-red-600/90 px-2.5 py-1 text-xs font-medium text-white">
          <i class="fa-solid fa-crown"></i> Superuser
        </span>
      {% elif user.profile.role == 'admin' %}
        <span class="absolute right-3 top-3 inline-flex items-center gap-1 rounded-full bg-blue-600/90 px-2.5 py-1 text-xs font-medium text-white">
          <i class="fa-solid fa-shield"></i> Admin
        </span>
      {% elif user.profile.role == 'blog_author' %}
        <span class="absolute right-3 top-3 inline-flex items-center gap-1 rounded-full bg-green-600/90 px-2.5 py-1 text-xs font-medium text-white">
          <i class="fa-solid fa-pen"></i> Blog Author
        </span>
      {% else %}
        <span class="absolute right-3 top-3 inline-flex items-center gap-1 rounded-full bg-gray-500/90 px-2.5 py-1 text-xs font-medium text-white">
          <i class="fa-solid fa-user"></i> User
        </span>
      {% endif %}
    </div>

    <!-- body -->
    <div class="p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="text-base font-semibold text-gray-900">{{ user.username }}</h3>
          {% if user.first_name or user.last_name %}
            <p class="text-sm text-gray-600">{{ user.first_name }} {{ user.last_name }}</p>
          {% endif %}
          {% if user.email %}
            <p class="text-sm text-gray-500">{{ user.email }}</p>
          {% endif %}
        </div>
        <div class="shrink-0">
          <!-- actions menu -->
          <div class="relative">
            <button type="button" class="action-btn rounded-lg p-1.5 hover:bg-gray-100">
              <svg class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><circle cx="10" cy="3" r="1.5"/><circle cx="10" cy="10" r="1.5"/><circle cx="10" cy="17" r="1.5"/></svg>
            </button>
            <div class="menu hidden absolute right-0 z-10 mt-1 w-36 overflow-hidden rounded-xl border border-gray-200 bg-white shadow-lg">
              <a href="{% url 'dashboard_user_edit' user.id %}" class="block px-3 py-2 text-sm hover:bg-gray-50">Edit Role</a>
              {% if not user.is_superuser %}
                <form action="{% url 'dashboard_user_delete' user.id %}" method="post" onsubmit="return confirm('Delete this user?');">
                  {% csrf_token %}
                  <button type="submit" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50">Delete</button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-2 text-sm text-gray-600">
        <span class="text-gray-400">Joined:</span>
        <span>{{ user.date_joined|date:"Y-m-d" }}</span>
        {% if user.last_login %}
          <span class="text-gray-400">•</span>
          <span>Last login: {{ user.last_login|date:"Y-m-d" }}</span>
        {% endif %}
      </div>
    </div>
  </article>
  {% empty %}
  <div class="col-span-full">
    <div class="rounded-2xl border border-dashed border-gray-300 bg-white py-16 text-center">
      <p class="text-gray-600">No users yet.</p>
      <a href="{% url 'dashboard_user_create' %}" class="mt-3 inline-flex rounded-xl bg-gray-900 px-4 py-2 text-white hover:bg-black">Create first user</a>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Table view (compact) -->
<div id="tableView" class="hidden overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm">
  <table class="min-w-full text-sm">
    <thead class="text-left text-gray-600">
      <tr>
        <th class="px-4 py-3">Username</th>
        <th class="px-4 py-3">Name</th>
        <th class="px-4 py-3">Email</th>
        <th class="px-4 py-3">Role</th>
        <th class="px-4 py-3">Joined</th>
        <th class="px-4 py-3"></th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for user in users %}
      <tr class="row" data-username="{{ user.username|lower }}" data-role="{{ user.profile.role|default:'user' }}" data-email="{{ user.email|default:''|lower }}">
        <td class="px-4 py-3 font-medium text-gray-900">{{ user.username }}</td>
        <td class="px-4 py-3 text-gray-700">{{ user.first_name }} {{ user.last_name }}</td>
        <td class="px-4 py-3 text-gray-700">{{ user.email }}</td>
        <td class="px-4 py-3">
          {% if user.is_superuser %}
            <span class="rounded-full bg-red-600/10 px-2.5 py-1 text-xs font-medium text-red-700">Superuser</span>
          {% elif user.profile.role == 'admin' %}
            <span class="rounded-full bg-blue-600/10 px-2.5 py-1 text-xs font-medium text-blue-700">Admin</span>
          {% elif user.profile.role == 'blog_author' %}
            <span class="rounded-full bg-green-600/10 px-2.5 py-1 text-xs font-medium text-green-700">Blog Author</span>
          {% else %}
            <span class="rounded-full bg-gray-600/10 px-2.5 py-1 text-xs font-medium text-gray-700">User</span>
          {% endif %}
        </td>
        <td class="px-4 py-3 text-gray-700">{{ user.date_joined|date:"Y-m-d" }}</td>
        <td class="px-4 py-3">
          <div class="flex items-center gap-3">
            <a href="{% url 'dashboard_user_edit' user.id %}" class="text-blue-700 hover:underline">Edit</a>
            {% if not user.is_superuser %}
              <form action="{% url 'dashboard_user_delete' user.id %}" method="post" onsubmit="return confirm('Delete this user?');">
                {% csrf_token %}
                <button class="text-red-700 hover:underline" type="submit">Delete</button>
              </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Tiny script: search/filter/view + actions menu -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const search = document.getElementById('searchInput');
  const role = document.getElementById('roleFilter');

  const cards = Array.from(document.querySelectorAll('.user-card'));
  const rows  = Array.from(document.querySelectorAll('#tableView .row'));

  function match(el, q, r){
    const username = (el.dataset.username || '');
    const email = (el.dataset.email || '');
    const role_data = (el.dataset.role || '');
    const okQ = !q || username.includes(q) || email.includes(q);
    const okR = (r === 'all') || (role_data === r);
    return okQ && okR;
  }
  function apply(){
    const q = (search.value || '').trim().toLowerCase();
    const r = role.value;
    cards.forEach(c => c.classList.toggle('hidden', !match(c, q, r)));
    rows.forEach(r => r.classList.toggle('hidden', !match(r, q, r)));
  }
  search.addEventListener('input', apply);
  role.addEventListener('change', apply);
  apply();

  // View toggle
  const cardsView = document.getElementById('cardsView');
  const tableView = document.getElementById('tableView');
  const btnCards  = document.getElementById('viewCardsBtn');
  const btnTable  = document.getElementById('viewTableBtn');
  function setView(v){
    const isCards = v === 'cards';
    cardsView.classList.toggle('hidden', !isCards);
    tableView.classList.toggle('hidden', isCards);
    btnCards.classList.toggle('bg-gray-900', isCards);
    btnCards.classList.toggle('text-white', isCards);
    btnTable.classList.toggle('bg-gray-900', !isCards);
    btnTable.classList.toggle('text-white', !isCards);
    localStorage.setItem('usersView', v);
  }
  setView(localStorage.getItem('usersView') || 'cards');
  btnCards.addEventListener('click', () => setView('cards'));
  btnTable.addEventListener('click', () => setView('table'));

  // Simple actions dropdown for cards
  document.querySelectorAll('.action-btn').forEach(btn=>{
    const menu = btn.parentElement.querySelector('.menu');
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); });
    document.addEventListener('click', ()=> menu.classList.add('hidden'));
  });

  // Keyboard: focus search with "/"
  document.addEventListener('keydown', (e)=>{
    if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault(); search.focus();
    }
  });
});
</script>
{% endblock %}
