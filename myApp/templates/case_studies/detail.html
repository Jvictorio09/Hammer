{% extends "base.html" %}
{% load static %}


{% block title %}{{ case_study.title }} | {{ case_study.service.title }} | Hammer Group{% endblock %}
{% block meta_description %}{{ case_study.summary|default:"Case study showcasing our work in "|add:case_study.service.title|truncatechars:160 }}{% endblock %}

<style>
:root {
  --lux-gold: #c7a770;
  --ink: #0f1220;
}
/* Gentle editorial polish */
.cs-dropcap p:first-of-type::first-letter{
  float:left; margin:.1em .25em 0 0; font-size:3.25rem; line-height:.85; font-weight:600; color:#111;
}
.cs-lead {
  font-size:1.125rem; line-height:1.8;
}
.cs-body p { margin: 1.15em 0; }
.cs-body h3 {
  font-size: .95rem; letter-spacing:.08em; text-transform:uppercase;
  color: #6b7280; font-weight:700; margin:2.25rem 0 .75rem;
}
.cs-callout {
  border:1px solid rgba(17,24,39,.1);
  background: linear-gradient(180deg,#fff, #f9fafb);
  border-radius: 1rem; padding:1rem 1.25rem;
}
.cs-quote {
  position:relative; border-left:3px solid var(--lux-gold);
  padding:1rem 1.25rem; background:linear-gradient(180deg,#fff, #faf7f1);
  border-radius:.75rem;
}
.cs-quote:before{
  content:"“"; position:absolute; left:.5rem; top:-.75rem; font-size:3rem; color:rgba(199,167,112,.25);
}
.cs-bullets li{
  display:flex; gap:.6rem; align-items:flex-start;
}
.cs-bullets li .dot{
  margin-top:.55rem; width:.45rem; height:.45rem; border-radius:999px; background:var(--lux-gold);
  box-shadow:0 0 0 3px rgba(199,167,112,.18);
}
.cs-gallery-masonry { column-fill:balance; }
.cs-hero-img { transform:scale(1.02); will-change:transform; transition:transform .6s ease; }
@media (min-width:1024px){ .cs-hero-pad{ padding-top:9.5rem; padding-bottom:6.5rem; } }
</style>

{% block content %}
<main class="bg-white text-gray-900 selection:bg-gray-900 selection:text-white">

  {# ================= HERO ================= #}
  <header class="relative isolate overflow-hidden">
    {% if case_study.hero_image_url %}
      <img src="{{ case_study.hero_image_url }}" alt="{{ case_study.title }}"
           class="cs-hero-img absolute inset-0 h-full w-full object-cover" />
    {% else %}
      <div class="absolute inset-0 bg-gradient-to-br from-[#0f1220] to-[#1c2233]"></div>
    {% endif %}
    <div class="absolute inset-0 bg-gradient-to-b from-black/50 via-black/35 to-black/20"></div>
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-20 md:pt-36 md:pb-24 cs-hero-pad">
      <nav class="mb-6 text-sm text-white/80">
        <a href="{% url 'home' %}" class="hover:text-white">Home</a>
        <span class="mx-2 text-white/60">/</span>
        <a href="{{ case_study.service.get_absolute_url }}" class="hover:text-white">{{ case_study.service.title }}</a>
      </nav>

      <h1 class="font-semibold tracking-tight text-white leading-[1.03]
                 text-4xl sm:text-5xl md:text-6xl lg:text-7xl">
        {{ case_study.title }}
      </h1>

      {% if case_study.summary %}
      <p class="mt-5 max-w-3xl text-white/90 text-lg md:text-xl leading-relaxed">
        {{ case_study.summary }}
      </p>
      {% endif %}

      <div class="mt-6 flex flex-wrap items-center gap-3">
        {% if case_study.location %}
          <span class="inline-flex items-center rounded-full bg-white/10 text-white border border-white/30 px-3 py-1.5 text-sm">{{ case_study.location }}</span>
        {% endif %}
        {% if case_study.project_type %}
          <span class="inline-flex items-center rounded-full bg-white/10 text-white border border-white/30 px-3 py-1.5 text-sm">{{ case_study.project_type|title }}</span>
        {% endif %}
        {% if case_study.completion_date %}
          <span class="inline-flex items-center rounded-full bg-white/10 text-white border border-white/30 px-3 py-1.5 text-sm">{{ case_study.completion_date|date:"F Y" }}</span>
        {% endif %}
      </div>
    </div>
  </header>

  {# ================= ARTICLE ================= #}
  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 lg:gap-12 mt-6 md:mt-8">
      {# ---- Sticky sidebar ---- #}
      <aside class="lg:col-span-4">
        <div class="lg:sticky lg:top-24 space-y-6">
          <section class="rounded-2xl border border-gray-200 bg-white p-6">
            <h3 class="text-xs font-semibold tracking-wider uppercase text-gray-500">Project Facts</h3>
            <dl class="mt-4 space-y-3 text-sm">
              {% if case_study.scope %}
              <div class="flex justify-between gap-4">
                <dt class="text-gray-500">Scope</dt><dd class="font-medium text-gray-900 text-right">{{ case_study.scope }}</dd>
              </div>
              {% endif %}
              {% if case_study.size_label %}
              <div class="flex justify-between gap-4">
                <dt class="text-gray-500">Size</dt><dd class="font-medium text-gray-900 text-right">{{ case_study.size_label }}</dd>
              </div>
              {% endif %}
              {% if case_study.timeline_label %}
              <div class="flex justify-between gap-4">
                <dt class="text-gray-500">Timeline</dt><dd class="font-medium text-gray-900 text-right">{{ case_study.timeline_label }}</dd>
              </div>
              {% endif %}
              {% if case_study.status_label %}
              <div class="flex justify-between gap-4">
                <dt class="text-gray-500">Status</dt><dd class="font-medium text-gray-900 text-right">{{ case_study.status_label }}</dd>
              </div>
              {% endif %}
              {% if case_study.completion_date %}
              <div class="flex justify-between gap-4">
                <dt class="text-gray-500">Completed</dt><dd class="font-medium text-gray-900 text-right">{{ case_study.completion_date|date:"F Y" }}</dd>
              </div>
              {% endif %}
            </dl>

            {% if case_study.tags_list %}
            <div class="mt-5 flex flex-wrap gap-2">
              {% for tag in case_study.tags_list %}
              <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-3 py-1.5 text-xs text-gray-800">
                {{ tag }}
              </span>
              {% endfor %}
            </div>
            {% endif %}

            <div class="mt-6 grid grid-cols-2 gap-3">
              <a href="{% url 'contact' %}" class="inline-flex items-center justify-center rounded-lg bg-gray-900 text-white px-4 py-2.5 text-sm font-semibold hover:bg-black">
                Start a project
              </a>
              <button id="copy-link" type="button" class="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-medium hover:bg-gray-50">
                Copy link
              </button>
            </div>
          </section>

          {% if case_study.summary %}
          <blockquote class="cs-quote">
            <p class="text-gray-900 text-base leading-relaxed">{{ case_study.summary }}</p>
          </blockquote>
          {% endif %}
        </div>
      </aside>

      {# ---- Editorial body ---- #}
      <div class="lg:col-span-8">
        <div class="cs-body cs-dropcap">
          <div id="cs-lead" class="cs-lead"></div>

          <div id="cs-dynamic">
            {# JS will populate H3 headings + bullet lists + paragraphs here #}
          </div>

          <div id="cs-outro" class="mt-8 text-gray-800 text-lg leading-relaxed"></div>
        </div>

        {# Feature strip #}
        <section class="mt-10 md:mt-12">
          <figure class="relative rounded-3xl overflow-hidden ring-1 ring-gray-200">
            <img src="{{ case_study.full_url|default:case_study.hero_image_url }}" alt="{{ case_study.title }}"
                 class="w-full h-auto object-cover" />
          </figure>
        </section>
      </div>
    </div>

    {# Hidden source for parser — NOTE: text/plain, not JSON #}
    <script type="text/plain" id="cs-desc-raw">{{ case_study.description|escape }}</script>

    {# If you’re using JSONField gallery_urls in CaseStudy, expose it. #}
    {% if case_study.gallery_urls %}
      {{ case_study.gallery_urls|json_script:"gallery-json" }}
    {% endif %}
  </article>

  {# ================= GALLERY ================= #}
  {% if gallery_images or case_study.gallery_urls %}
  <section class="mt-16 md:mt-24 bg-[#0f1220] text-white relative">
    <div class="absolute inset-0 opacity-[0.08] pointer-events-none"
         style="background-image: radial-gradient(600px 220px at 20% 10%, #c7a77033, transparent 60%), radial-gradient(500px 200px at 80% 90%, #c7a77033, transparent 60%);"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20 relative">
      <h2 class="text-3xl md:text-4xl font-semibold text-center">Project Gallery</h2>
      <p class="mt-2 text-center text-white/80">Highlights from design + build</p>

      <div class="mt-10 lg:columns-3 lg:gap-6 cs-gallery-masonry space-y-4 lg:space-y-6">
        {% if gallery_images %}
          {% for image in gallery_images %}
          <figure class="break-inside-avoid relative overflow-hidden rounded-2xl bg-white/5 ring-1 ring-white/10 hover:ring-white/20 transition cursor-zoom-in"
                  onclick="openLightbox({{ forloop.counter0 }})">
            <img src="{{ image.thumb_url }}" alt="{{ image.caption|default:'Project image' }}"
                 class="w-full h-auto object-cover transition duration-500 group-hover:scale-[1.02]" loading="lazy" />
            {% if image.caption %}
              <figcaption class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 text-sm">{{ image.caption }}</figcaption>
            {% endif %}
          </figure>
          {% endfor %}
        {% else %}
          {# Render from JSONField (gallery_urls: [{thumb, full, caption}]) #}
          <template id="tmpl-gallery-card">
            <figure class="break-inside-avoid relative overflow-hidden rounded-2xl bg-white/5 ring-1 ring-white/10 hover:ring-white/20 transition cursor-zoom-in">
              <img class="w-full h-auto object-cover transition duration-500 group-hover:scale-[1.02]" loading="lazy" />
              <figcaption class="caption absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 text-sm hidden"></figcaption>
            </figure>
          </template>
          <div id="gallery-json-render" class="contents"></div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/95 flex items-center justify-center p-4" onclick="closeLightbox()">
    <button aria-label="Close" class="absolute top-4 right-4 text-white/90 hover:text-white text-4xl font-light" onclick="closeLightbox()">&times;</button>
    <button aria-label="Previous" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/90 hover:text-white text-4xl font-light" onclick="event.stopPropagation(); prevImage()">&lsaquo;</button>
    <button aria-label="Next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/90 hover:text-white text-4xl font-light" onclick="event.stopPropagation(); nextImage()">&rsaquo;</button>
    <div class="max-w-6xl w-full" onclick="event.stopPropagation()">
      <img id="lightbox-img" src="" alt="" class="w-full h-auto max-h-[85vh] object-contain rounded-xl shadow-2xl ring-1 ring-white/10" />
      <p id="lightbox-caption" class="text-white/80 text-center mt-4 text-sm"></p>
    </div>
  </div>
  {% endif %}

  {# ================= RELATED ================= #}
  {% if related_case_studies %}
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20">
    <div class="flex items-center justify-between mb-8 md:mb-10">
      <h2 class="text-3xl md:text-4xl font-semibold">Related Projects</h2>
      <a href="{{ case_study.service.get_absolute_url }}" class="text-sm font-semibold text-gray-600 hover:text-gray-900">
        View all {{ case_study.service.title }}
      </a>
    </div>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {% for related in related_case_studies %}
      <a href="{{ related.get_absolute_url }}" class="group block focus:outline-none focus:ring-2 focus:ring-[#c7a770]/30 rounded-2xl">
        <article class="bg-white rounded-2xl overflow-hidden border border-gray-200/70 shadow-sm hover:shadow-[0_24px_60px_-20px_rgba(0,0,0,0.35)] transition-all">
          <div class="aspect-[16/10] overflow-hidden bg-gray-100">
            {% if related.hero_image_url %}
              <img src="{{ related.hero_image_url }}" alt="{{ related.title }}"
                   class="h-full w-full object-cover group-hover:scale-[1.02] transition-transform duration-500" loading="lazy" />
            {% endif %}
          </div>
          <div class="p-6">
            <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-1">{{ related.title }}</h3>
            {% if related.summary %}
              <p class="text-gray-600 text-sm line-clamp-2">{{ related.summary }}</p>
            {% endif %}
          </div>
        </article>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {# ================= CTA ================= #}
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-[#0f1220]"></div>
    <div aria-hidden="true" class="absolute -left-24 -top-24 h-80 w-80 rounded-full bg-[#c7a770]/20 blur-3xl"></div>
    <div aria-hidden="true" class="absolute right-[-5rem] bottom-[-6rem] h-72 w-72 rounded-full bg-[#c7a770]/20 blur-3xl"></div>

    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20 text-center text-white">
      <h2 class="text-3xl md:text-4xl font-semibold mb-3">Ready to build your space?</h2>
      <p class="text-base md:text-lg text-white/80 mb-8">Let’s design and deliver something timeless—beautiful, durable, and effortless to live with.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="{% url 'contact' %}" class="inline-flex items-center justify-center px-6 py-3 rounded-full bg-white text-gray-900 font-semibold hover:bg-gray-100">Get in touch</a>
        <a href="{{ case_study.service.get_absolute_url }}" class="inline-flex items-center justify-center px-6 py-3 rounded-full border border-white/30 text-white font-semibold hover:bg-white/10">View {{ case_study.service.title }}</a>
      </div>
    </div>
  </section>

</main>

{# ================= JS ================= #}
<script>
  // Copy link
  const copyBtn = document.getElementById('copy-link');
  if (copyBtn) {
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        const prev = copyBtn.textContent;
        copyBtn.textContent = 'Link copied';
        setTimeout(() => (copyBtn.textContent = prev), 1400);
      } catch (e) {}
    });
  }

  // Light parallax on hero (subtle, no jank)
  (function(){
    const hero = document.querySelector('.cs-hero-img');
    if (!hero) return;
    let ticking = false;
    const onScroll = () => {
      if (ticking) return;
      window.requestAnimationFrame(() => {
        const y = window.scrollY || 0;
        const scale = 1.02 + Math.min(y/3000, 0.02);
        hero.style.transform = `scale(${scale.toFixed(3)})`;
        ticking = false;
      });
      ticking = true;
    };
    window.addEventListener('scroll', onScroll, { passive: true });
  })();

  // Lightbox (works for both Server-rendered & JSON gallery)
  let images = [
    {% if gallery_images %}
      {% for image in gallery_images %}
        { full: "{{ image.full_url }}", caption: "{{ image.caption|default:''|escapejs }}" }{% if not forloop.last %},{% endif %}
      {% endfor %}
    {% else %}
      // Will fill from gallery_json if present
    {% endif %}
  ];
  let currentIndex = 0;
  function openLightbox(index){ currentIndex=index; updateLightbox(); const lb=document.getElementById('lightbox'); lb.classList.remove('hidden'); document.body.style.overflow='hidden'; }
  function closeLightbox(){ const lb=document.getElementById('lightbox'); if(!lb) return; lb.classList.add('hidden'); document.body.style.overflow=''; }
  function nextImage(){ if(!images.length) return; currentIndex=(currentIndex+1)%images.length; updateLightbox(); }
  function prevImage(){ if(!images.length) return; currentIndex=(currentIndex-1+images.length)%images.length; updateLightbox(); }
  function updateLightbox(){ const img=document.getElementById('lightbox-img'); const cap=document.getElementById('lightbox-caption'); if(img) img.src=images[currentIndex]?.full||''; if(cap) cap.textContent=images[currentIndex]?.caption||''; }
  document.addEventListener('keydown',(e)=>{ const lb=document.getElementById('lightbox'); if(!lb||lb.classList.contains('hidden')) return; if(e.key==='Escape') closeLightbox(); if(e.key==='ArrowLeft') prevImage(); if(e.key==='ArrowRight') nextImage(); });

  // If gallery is from JSONField, render it client-side
  (function(){
    const jsonNode = document.getElementById('gallery-json');
    const mount = document.getElementById('gallery-json-render');
    if (!jsonNode || !mount) return;
    try {
      const data = JSON.parse(jsonNode.textContent || '[]');
      if (!Array.isArray(data)) return;
      images = data.map((d, i) => ({ full: d.full || d.thumb || '', caption: d.caption || '' }));
      const tmpl = document.getElementById('tmpl-gallery-card');
      data.forEach((item, idx) => {
        const node = tmpl.content.cloneNode(true);
        const img = node.querySelector('img');
        const cap = node.querySelector('.caption');
        img.src = item.thumb || item.full || '';
        img.alt = item.caption || 'Project image';
        node.firstElementChild.onclick = () => openLightbox(idx);
        if (item.caption) { cap.textContent = item.caption; cap.classList.remove('hidden'); }
        mount.appendChild(node);
      });
    } catch (e) {}
  })();

  // ================= Editorial parser =================
  // Reads RAW TEXT (no JSON.parse) and renders:
  // - Lead paragraph (dropcap)
  // - Headings: CHALLENGES, WHAT WE DID / OUR SOLUTION / DELIVERED, RESULTS, MATERIALS
  // - Bullets: lines starting with —, –, -, •
  // - Pull-quotes: lines starting with ">"
  // - Normal paragraphs otherwise
  (function(){
    const src = document.getElementById('cs-desc-raw');
    if (!src) return;
    const raw = String(src.textContent || '').replace(/\r\n/g, '\n').trim();

    const H = {
      CHALLENGES: /\b(THE\s+CHALLENGE|CHALLENGES)\s*:?\s*/i,
      DID: /\b(WHAT\s+WE\s+DID|OUR\s+SOLUTION|DELIVERED)\s*:?\s*/i,
      RESULTS: /\b(RESULTS|IMPACT|OUTCOME)\s*:?\s*/i,
      MATERIALS: /\b(MATERIALS|SYSTEMS|SPEC)\s*:?\s*/i,
    };
    const bullet = /^\s*[—–\-•]\s+/;
    const pull = /^\s*\>\s?/;

    const sanitize = (s) =>
      s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // naive inline bold/italic (safe since we escape first)
    const inlineFormat = (s) =>
      s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
       .replace(/\*([^*]+)\*/g, '<em>$1</em>');

    const leadEl = document.getElementById('cs-lead');
    const bodyEl = document.getElementById('cs-dynamic');
    const outroEl = document.getElementById('cs-outro');

    // Split into chunks around known headings (keep the headings)
    const marks = [];
    for (const [key, re] of Object.entries(H)) {
      const m = raw.match(re);
      if (m) marks.push({ key, idx: m.index, len: m[0].length });
    }
    marks.sort((a,b)=>a.idx-b.idx);

    let lead = raw, rest = '';
    if (marks.length){
      lead = raw.slice(0, marks[0].idx).trim();
      rest = raw.slice(marks[0].idx);
    }

    // Render lead
    if (leadEl && lead) {
      leadEl.innerHTML = inlineFormat(sanitize(lead));
    }

    // Parse the rest by walking headings
    function sectionSlice(src, startIdx){
      const here = marks[startIdx];
      const next = marks[startIdx+1];
      const start = here.idx + here.len;
      const end = next ? next.idx : src.length;
      return { key: here.key, text: src.slice(start, end).trim() };
    }

    function renderBullets(lines){
      const ul = document.createElement('ul');
      ul.className = 'cs-bullets space-y-2.5';
      lines.forEach(t=>{
        const li = document.createElement('li');
        const dot = document.createElement('span');
        dot.className = 'dot';
        const span = document.createElement('span');
        span.className = 'leading-relaxed';
        span.innerHTML = inlineFormat(sanitize(t.replace(bullet,'')));
        li.appendChild(dot); li.appendChild(span);
        ul.appendChild(li);
      });
      return ul;
    }

    function renderParagraph(t){
      const p = document.createElement('p');
      p.innerHTML = inlineFormat(sanitize(t));
      return p;
    }

    function renderQuote(t){
      const q = document.createElement('blockquote');
      q.className = 'cs-callout';
      const p = document.createElement('p');
      p.innerHTML = inlineFormat(sanitize(t.replace(pull,'')));
      q.appendChild(p);
      return q;
    }

    function renderSection(title){
      const h = document.createElement('h3');
      h.textContent = title;
      return h;
    }

    if (bodyEl && rest){
      // Walk each section
      for (let i=0;i<marks.length;i++){
        const { key, text } = sectionSlice(raw, i);
        let title = key === 'CHALLENGES' ? 'Challenges'
                 : key === 'DID' ? 'What we did'
                 : key === 'RESULTS' ? 'Results'
                 : key === 'MATERIALS' ? 'Materials'
                 : key;
        bodyEl.appendChild(renderSection(title));

        const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
        const bullets = lines.filter(l=>bullet.test(l));
        const quotes  = lines.filter(l=>pull.test(l));
        const paras   = lines.filter(l=>!bullet.test(l) && !pull.test(l));

        if (bullets.length) bodyEl.appendChild(renderBullets(bullets));
        quotes.forEach(q=> bodyEl.appendChild(renderQuote(q)));
        // Group paragraphs into one soft block for rhythm
        if (paras.length){
          const wrap = document.createElement('div');
          paras.forEach(p=> wrap.appendChild(renderParagraph(p)));
          bodyEl.appendChild(wrap);
        }
      }
    }

    // Outro: anything after the last blank line in the original DID/RESULTS area is handled already;
    // if you want a hard outro, keep original behavior:
    if (outroEl && !outroEl.textContent){
      // minimal heuristic: last two paragraphs of raw as outro if no explicit RESULTS
      if (!H.RESULTS.test(raw)){
        const blocks = raw.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
        if (blocks.length>1){
          const last = blocks.slice(-1)[0];
          outroEl.innerHTML = inlineFormat(sanitize(last));
        }
      }
    }
  })();
</script>
{% endblock %}
