{# templates/projects/index.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}{{ meta_title }}{% endblock %}

{% block extra_head %}
  <meta name="description" content="{{ meta_desc }}">
  <link rel="canonical" href="{{ request.build_absolute_uri|cut:'?' }}">
  <meta name="robots" content="index,follow">

  {# Prev/next for SEO pagination #}
  {% if page_obj.paginator.num_pages > 1 %}
    {% if page_obj.has_previous %}
      <link rel="prev" href="?page={{ page_obj.previous_page_number }}">
    {% endif %}
    {% if page_obj.has_next %}
      <link rel="next" href="?page={{ page_obj.next_page_number }}">
    {% endif %}
  {% endif %}

  {# Open Graph / Twitter #}
  <meta property="og:title" content="{{ meta_title }}">
  <meta property="og:description" content="{{ meta_desc }}">
  <meta property="og:type" content="website">
  {% with hero=page_obj.object_list|first %}
    {% if hero %}
      <meta property="og:image" content="{{ hero.thumb_url|default:hero.full_url }}">
      <meta name="twitter:card" content="summary_large_image">
    {% endif %}
  {% endwith %}

  {# JSON-LD: WebPage + Breadcrumb + a small ImageGallery from this page #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "{{ meta_title|escapejs }}",
    "description": "{{ meta_desc|escapejs }}",
    "url": "{{ request.build_absolute_uri|cut:'?' }}",
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Home", "item": "{{ request.build_absolute_uri|cut:request.get_full_path }}{% url 'home' %}" },
        { "@type": "ListItem", "position": 2, "name": "Projects", "item": "{{ request.build_absolute_uri|cut:'?' }}" }
      ]
    },
    "hasPart": {
      "@type": "ImageGallery",
      "name": "Project Images",
      "associatedMedia": [
        {% for p in page_obj.object_list|slice:":8" %}
        { "@type": "ImageObject", "contentUrl": "{{ p.full_url }}", "caption": "{{ p.caption|default:'Project'|escapejs }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    }
  }
  </script>
{% endblock %}

{% block content %}
<style>
  :root{ --ink:#0B0E14; --teal:#18AFAB; --sand:#F6F3EE; }
  .chip{font-size:.78rem;padding:.35rem .7rem;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;transition:all .2s;display:inline-flex;align-items:center;gap:.4rem}
  .chip:is(:hover,:focus){transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.08)}
  .chip--active{background:var(--teal);color:#fff;border-color:transparent;box-shadow:0 8px 22px rgba(24,175,171,.25)}
  .proj-card{border-radius:1rem;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff;transition:transform .25s,box-shadow .25s,border-color .25s}
  .proj-card:hover{transform:translateY(-2px);box-shadow:0 18px 38px rgba(0,0,0,.16),0 0 0 1px rgba(24,175,171,.12) inset;border-color:rgba(24,175,171,.25)}
  .tag{font-size:.7rem;padding:.2rem .5rem;border-radius:999px;background:#f3f4f6;color:#374151}
  .grid-auto{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:1rem}
  @media (min-width:640px){.grid-auto{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (min-width:1024px){.grid-auto{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (min-width:1280px){.grid-auto{grid-template-columns:repeat(4,minmax(0,1fr))}}

  /* Lightbox */
  .lb{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,12,18,.86);backdrop-filter:saturate(120%) blur(6px);z-index:70}
  .lb.is-open{display:flex}
  .lb-inner{position:relative;max-width:min(96vw,1400px);max-height:90vh;outline:none}
  .lb-img{display:block;max-width:100%;max-height:90vh;width:auto;height:auto;object-fit:contain;border-radius:12px;box-shadow:0 24px 60px rgba(0,0,0,.5)}
  .lb-top{position:absolute;top:.75rem;left:.75rem;right:.75rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  .lb-btn{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.35);color:#fff}
  .lb-btn:hover{background:rgba(255,255,255,.12)}
  .lb-num{color:#fff;font-weight:700;font-size:.8rem;opacity:.85}
  .lb-cap{position:absolute;left:.75rem;right:.75rem;bottom:.75rem;color:#fff;background:linear-gradient(to top,rgba(0,0,0,.5),rgba(0,0,0,.1));padding:.6rem .75rem;border-radius:.75rem;font-size:.9rem}
  .visually-hidden{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap;}
  body.lb-lock{overflow:hidden}
</style>

<section class="bg-white">
  <div class="max-w-7xl mx-auto px-6 pt-14 md:pt-20">
    <header class="mb-8 md:mb-10">
      <p class="text-[10px] tracking-[.35em] uppercase text-[var(--teal)]">Projects</p>
      <h1 class="mt-2 text-3xl md:text-4xl font-extrabold text-[var(--ink)]">
        {% if current_service %}{{ current_service.title }}{% else %}Our Design &amp; Build Projects in Dubai{% endif %}
      </h1>
      <p class="mt-3 text-gray-600 max-w-3xl">
        {% if current_service %}
          Discover recent {{ current_service.title|lower }} projects—premium finishes, disciplined delivery and on-time handover across Dubai’s most prestigious locations.
        {% else %}
          Discover how Hammer Group delivers excellence across Dubai with bespoke landscaping, luxurious villas, refined interiors and reliable facility solutions—crafted details, premium materials, and a transparent weekly cadence.
        {% endif %}
      </p>
    </header>

    {# Filter chips #}
    <nav class="flex flex-wrap gap-2 mb-8" aria-label="Project filters">
      <a href="{% url 'projects_index' %}"
         class="chip {% if not current_service %}chip--active{% endif %}">All</a>
      {% for s in services %}
        <a href="{% url 'projects_by_service' s.slug %}"
           class="chip {% if current_service and current_service.id == s.id %}chip--active{% endif %}">
          {{ s.title }}
        </a>
      {% endfor %}
    </nav>
  </div>

  <div class="max-w-7xl mx-auto px-6 pb-14 md:pb-20">
    {% if page_obj.object_list %}
      <div class="grid-auto" id="projGrid">
        {% for p in page_obj.object_list %}
          <article class="proj-card">
            <button
              class="block w-full text-left open-lb"
              data-index="{{ forloop.counter0 }}"
              data-src="{{ p.full_url }}"
              data-alt="{{ p.caption|default:'Project image'|escape }}"
              data-cap="{{ p.caption|default:'Project'|escape }}"
              aria-label="Open image: {{ p.caption|default:'Project image'|escape }}"
            >
              <img
                src="{{ p.thumb_url|default:p.full_url }}"
                alt="{{ p.caption|default:'Project image' }}"
                class="w-full h-60 sm:h-64 md:h-56 lg:h-60 xl:h-64 object-cover"
                loading="lazy"
                sizes="(min-width:1280px) 25vw, (min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw"
                referrerpolicy="no-referrer"
              >
            </button>
            <div class="p-4">
              <div class="flex items-center justify-between gap-3">
                <h3 class="font-semibold text-[var(--ink)] truncate">
                  {{ p.caption|default:"Project" }}
                </h3>
                <span class="tag">{{ p.service.title }}</span>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>

      {# Pagination #}
      {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-8 flex items-center justify-center gap-2">
          {% if page_obj.has_previous %}
            <a class="chip" href="?page={{ page_obj.previous_page_number }}">Prev</a>
          {% else %}
            <span class="chip opacity-50 cursor-not-allowed">Prev</span>
          {% endif %}

          <span class="text-sm text-gray-600 px-2">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="chip" href="?page={{ page_obj.next_page_number }}">Next</a>
          {% else %}
            <span class="chip opacity-50 cursor-not-allowed">Next</span>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div class="text-center py-16">
        <p class="text-gray-600">No projects yet. Add some <code>ServiceProjectImage</code> entries to your services.</p>
      </div>
    {% endif %}
  </div>
</section>

{# Accessible, no-lib lightbox #}
<div id="lightbox" class="lb" aria-modal="true" role="dialog" aria-label="Project image viewer">
  <div class="lb-inner" tabindex="-1">
    <div class="lb-top">
      <span class="lb-num" id="lbNum">1 / 1</span>
      <div class="flex items-center gap-2">
        <button class="lb-btn" id="lbPrev" aria-label="Previous image"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="lb-btn" id="lbNext" aria-label="Next image"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="lb-btn" id="lbClose" aria-label="Close viewer"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <img id="lbImg" class="lb-img" alt="">
    <div id="lbCap" class="lb-cap"></div>
  </div>
</div>

{% include "partials/contact.html" %}
<script>
(function(){
  const grid   = document.getElementById('projGrid');
  const lb     = document.getElementById('lightbox');
  const lbImg  = document.getElementById('lbImg');
  const lbCap  = document.getElementById('lbCap');
  const lbNum  = document.getElementById('lbNum');
  const btnPrev= document.getElementById('lbPrev');
  const btnNext= document.getElementById('lbNext');
  const btnClose=document.getElementById('lbClose');
  const inner  = lb.querySelector('.lb-inner');

  if(!grid || !lb) return;

  // Build an array of items from buttons
  const items = [...grid.querySelectorAll('.open-lb')].map((b, i) => ({
    src: b.dataset.src,
    alt: b.dataset.alt || 'Project image',
    cap: b.dataset.cap || '',
    btn: b,
    idx: i
  }));
  let idx = 0;
  let lastFocus = null;

  function open(index){
    idx = index;
    lastFocus = document.activeElement;
    update();
    lb.classList.add('is-open');
    document.body.classList.add('lb-lock');
    // focus trap anchor
    setTimeout(()=> inner.focus(), 0);
  }

  function close(){
    lb.classList.remove('is-open');
    document.body.classList.remove('lb-lock');
    if(lastFocus) lastFocus.focus();
  }

  function update(){
    const it = items[idx];
    lbImg.src = it.src;
    lbImg.alt = it.alt;
    lbCap.textContent = it.cap;
    lbNum.textContent = (idx+1) + ' / ' + items.length;
  }

  function prev(){ idx = (idx - 1 + items.length) % items.length; update(); }
  function next(){ idx = (idx + 1) % items.length; update(); }

  // Open handlers
  grid.addEventListener('click', (e)=>{
    const b = e.target.closest('.open-lb');
    if(!b) return;
    e.preventDefault();
    const i = parseInt(b.dataset.index || '0', 10);
    open(i);
  });

  // Buttons
  btnPrev.addEventListener('click', prev);
  btnNext.addEventListener('click', next);
  btnClose.addEventListener('click', close);

  // Dismiss on backdrop click (but not when clicking image/controls)
  lb.addEventListener('click', (e)=>{ if(e.target === lb) close(); });

  // Keys
  document.addEventListener('keydown', (e)=>{
    if(!lb.classList.contains('is-open')) return;
    if(e.key === 'Escape') close();
    else if(e.key === 'ArrowLeft') prev();
    else if(e.key === 'ArrowRight') next();
  });

  // Basic focus trap
  lb.addEventListener('keydown', (e)=>{
    if(e.key !== 'Tab') return;
    const focusables = [btnPrev, btnNext, btnClose, inner];
    const first = focusables[0], last = focusables[focusables.length - 1];
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  });
})();
</script>
{% endblock %}
